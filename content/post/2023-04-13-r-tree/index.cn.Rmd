---
title: Rç»˜åˆ¶ä¼˜ç¾çš„è¿›åŒ–æ ‘ï¼ˆåŸºç¡€ï¼‰
author: Peng Chen
date: '2023-04-14'
slug: r-tree
categories:
  - R
tags:
  - å¯è§†åŒ–
  - è¿›åŒ–æ ‘
  - phylogenetic tree
description: ä»‹ç»ç»˜åˆ¶è¿›åŒ–æ ‘ç”¨çš„ggtreeä»¥åŠä¸€äº›æ‹“å±•åŒ…çš„åŸºç¡€ç”¨æ³•ï¼Œå› ä¸ºggç³»åˆ—ç»˜å›¾çš„é€»è¾‘åŸºæœ¬æ˜¯æ­ç§¯æœ¨ï¼Œè¿™ç§ä»‹ç»æ€§çš„æ–‡ç« èƒ½å¤Ÿå¸®åŠ©å¿«é€Ÿçš„æ‰¾åˆ°æƒ³è¦çš„â€œç§¯æœ¨â€ä»¥åŠæ‹¼æ¥çš„æ–¹æ³•ï¼Œå‰©ä¸‹çš„å°±æ˜¯éšå¿ƒæ‰€æ¬²è®¾è®¡æƒ³è¦çš„å›¾äº†ã€‚
image: index.cn_files/figure-html/unnamed-chunk-15-1.png
math: ~
license: ~
hidden: no
comments: yes
bibliography: [../../bib/My Library.bib]
link-citations: yes
csl: ../../bib/science.csl
---

```{r include=FALSE}
Packages <- c("dplyr","kableExtra","ggplot2","ggtree","ggtreeExtra","treedataverse")
pcutils::lib_ps(Packages)
knitr::opts_chunk$set(message = FALSE,warning = FALSE,eval = T,cache = T)
```

è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»‹ç»ç»˜åˆ¶è¿›åŒ–æ ‘ç”¨çš„ggtreeä»¥åŠä¸€äº›æ‹“å±•åŒ…çš„åŸºç¡€ç”¨æ³•ï¼Œå› ä¸ºggç³»åˆ—ç»˜å›¾çš„é€»è¾‘åŸºæœ¬æ˜¯æ­ç§¯æœ¨ï¼Œè¿™ç§ä»‹ç»æ€§çš„æ–‡ç« èƒ½å¤Ÿå¸®åŠ©å¿«é€Ÿçš„æ‰¾åˆ°æƒ³è¦çš„â€œç§¯æœ¨â€ä»¥åŠæ‹¼æ¥çš„æ–¹æ³•ï¼Œå‰©ä¸‹çš„å°±æ˜¯éšå¿ƒæ‰€æ¬²è®¾è®¡æƒ³è¦çš„å›¾äº†ã€‚æ‰€ä»¥è¿™ç¯‡å‡ºçš„å›¾å¯èƒ½ä¸æ˜¯å¾ˆâ€œæ¼‚äº®â€ï¼Œä¸‹æ¬¡ä¸€å®šæä¸€ç¯‡æä¾›å¤ç°å„ç§æ–‡ç« ç¾å›¾çš„ä»£ç çš„æ¨æ–‡ğŸ’ªã€‚

## Introduction

åœ¨æ•°å­¦ä¸­ï¼Œ"æ ‘"æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ— å‘å›¾ï¼Œå®ƒæ²¡æœ‰ä»»ä½•å¾ªç¯ï¼Œå¹¶ä¸”ä»»æ„ä¸¤ä¸ªé¡¶ç‚¹ä¹‹é—´éƒ½åªæœ‰ä¸€æ¡ç®€å•è·¯å¾„ã€‚æ ‘é€šå¸¸ç”¨äºå»ºç«‹å±‚æ¬¡å…³ç³»ï¼Œæ¯”å¦‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œç”¨æ ‘æ¥è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿã€ç¨‹åºçš„è°ƒç”¨å…³ç³»ã€HTMLæ–‡æ¡£çš„DOMç»“æ„ç­‰ç­‰ã€‚æ ‘ä¹Ÿæ˜¯ç®—æ³•å’Œæ•°æ®ç»“æ„ä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œè®¸å¤šé—®é¢˜å¯ä»¥ç”¨æ ‘æ¥è§£å†³ï¼Œæ¯”å¦‚æœç´¢ã€æ’åºã€ç¼–ç ç­‰ç­‰ã€‚

**ç³»ç»Ÿå‘è‚²æ ‘ï¼ˆPhylogenetic treeï¼‰** æ˜¯ä¸€ç§ç”¨äºæè¿°ä¸åŒç‰©ç§æˆ–ç”Ÿç‰©ä½“ç³»ä¹‹é—´è¿›åŒ–å…³ç³»çš„æ ‘å½¢ç»“æ„ã€‚å®ƒæ˜¯ä¸€ç§åˆ†æ”¯å›¾ï¼Œç”¨äºè¡¨ç¤ºç”Ÿå‘½çš„è¿›åŒ–å†å²ï¼Œä»å…±åŒç¥–å…ˆå¼€å§‹ï¼Œæ²¿ç€æ—¶é—´è½´å‘åå±•å¼€ã€‚ç³»ç»Ÿå‘è‚²æ ‘é€šå¸¸æ˜¯åŸºäºå„ç§ç”Ÿç‰©å­¦æ•°æ®çš„åˆ†ææ‰€å»ºç«‹çš„ï¼Œå¦‚å½¢æ€ç‰¹å¾ã€åŸºå› åºåˆ—ã€è›‹ç™½è´¨åºåˆ—ã€ç”ŸåŒ–ååº”ç­‰ï¼Œä»¥ä¾¿è¯†åˆ«ç‰©ç§ä¹‹é—´çš„é—ä¼ å˜å¼‚å’Œæ¼”åŒ–è¶‹åŠ¿ã€‚

ç³»ç»Ÿå‘è‚²æ ‘çš„æ ‘æä»£è¡¨æ¼”åŒ–åˆ†æ”¯ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºå„ä¸ªç‰©ç§çš„æœ€è¿‘å…±åŒç¥–å…ˆï¼Œæ ‘æçš„é•¿åº¦è¡¨ç¤ºæ¼”åŒ–è·ç¦»æˆ–è¿›åŒ–æ—¶é—´ã€‚ç³»ç»Ÿå‘è‚²æ ‘çš„å½¢çŠ¶å’Œç»“æ„å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£ä¸åŒç‰©ç§ä¹‹é—´çš„äº²ç¼˜å…³ç³»ï¼Œäº†è§£ç”Ÿç‰©è¿›åŒ–å’Œæ¼”åŒ–è¿‡ç¨‹ã€‚åœ¨ç”Ÿç‰©åˆ†ç±»å­¦ã€ç”Ÿæ€å­¦ã€ç”Ÿç‰©åœ°ç†å­¦å’Œç”Ÿç‰©æŠ€æœ¯ç­‰é¢†åŸŸä¸­ï¼Œç³»ç»Ÿå‘è‚²æ ‘éƒ½å…·æœ‰é‡è¦çš„åº”ç”¨ä»·å€¼ã€‚

## Visualization

æœ‰å¾ˆå¤šè½¯ä»¶å¹³å°å¯ä»¥ç”¨æ¥å¯è§†åŒ–Phylogenetic treeï¼Œä¸‹é¢åˆ—ä¸¾ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„ï¼š

1.  iTOL (Interactive Tree Of Life)ï¼šè¿™æ˜¯ä¸€ä¸ªåœ¨çº¿å·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºã€æ³¨é‡Šå’Œå¯è§†åŒ–Phylogenetic treeã€‚å®ƒæä¾›äº†å¤šç§æ ·å¼å’Œæ³¨é‡Šé€‰é¡¹ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰æ˜¾ç¤ºæ•ˆæœã€‚ç½‘å€ä¸ºï¼š[**https://itol.embl.de/**](https://itol.embl.de/)**ï¼ˆä¸ä»˜è´¹çš„è¯æ— æ³•ä¿å­˜ä¸­é—´æ­¥éª¤ï¼Œæ³¨é‡Šæ–¹æ³•ä¸å¤ªå‹å¥½[Doge]ï¼‰**

2.  FigTreeï¼šè¿™æ˜¯ä¸€ä¸ªå…è´¹çš„è½¯ä»¶ï¼Œå¯ä»¥åœ¨Macå’ŒWindowsç³»ç»Ÿä¸Šè¿è¡Œã€‚å®ƒå¯ä»¥å¯è§†åŒ–Nexusã€Newickå’ŒNexmlç­‰æ ¼å¼çš„Phylogenetic treeï¼Œå¹¶æä¾›äº†å¤šç§æ ·å¼å’Œæ³¨é‡Šé€‰é¡¹ã€‚ç½‘å€ä¸ºï¼š[**http://tree.bio.ed.ac.uk/software/figtree/**](http://tree.bio.ed.ac.uk/software/figtree/)

3.  Phylo.ioï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªåœ¨çº¿å·¥å…·ï¼Œå¯ä»¥å¯è§†åŒ–Phylogenetic treeå¹¶è¿›è¡Œè‡ªå®šä¹‰æ³¨é‡Šã€‚å®ƒè¿˜æä¾›äº†äº¤äº’å¼åŠŸèƒ½ï¼Œå¯ä»¥æ¢ç´¢å’Œæ¯”è¾ƒä¸åŒéƒ¨åˆ†ä¹‹é—´çš„å…³ç³»ã€‚ç½‘å€ä¸ºï¼š[**https://phylo.io/**](https://phylo.io/)

4.  Dendroscopeï¼šè¿™æ˜¯ä¸€ä¸ªåŸºäºJavaçš„è½¯ä»¶ï¼Œå¯ä»¥ç”¨æ¥å¯è§†åŒ–Phylogenetic treeå¹¶è¿›è¡Œæ¯”è¾ƒå’Œæ³¨é‡Šã€‚å®ƒæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼ŒåŒ…æ‹¬Nexusã€Newickã€Phylipç­‰ã€‚ç½‘å€ä¸ºï¼š[**http://dendroscope.org/**](http://dendroscope.org/)

5.  MEGA (Molecular Evolutionary Genetics Analysis)ï¼šè¿™æ˜¯ä¸€ä¸ªå…è´¹çš„è½¯ä»¶ï¼Œå¯ä»¥ç”¨äºåˆ†å­è¿›åŒ–åˆ†æå’Œå¯è§†åŒ–ã€‚å®ƒå¯ä»¥åˆ›å»ºã€æ³¨é‡Šå’Œå¯è§†åŒ–Phylogenetic treeï¼Œå¹¶æä¾›äº†å¤šç§æ ·å¼å’Œæ³¨é‡Šé€‰é¡¹ã€‚ç½‘å€ä¸ºï¼š[**https://www.megasoftware.net/**](https://www.megasoftware.net/)

å½“ç„¶ï¼Œåœ¨çº¿å¹³å°å’Œå¸¦GUIç•Œé¢çš„è½¯ä»¶æœ‰ä¸€å®šå¼Šç«¯ï¼Œæ“çºµä¸æ˜¯é‚£ä¹ˆè‡ªç”±ã€‚åœ¨Rè¯­è¨€ä¸­ï¼Œç”¨äºå¯è§†åŒ–Phylogenetic treeçš„åŒ…ä¹Ÿæœ‰å¾ˆå¤šï¼š

1.  **ggtree @yuGgtreePackageVisualization2017 +ggtreeExtra @xuGgtreeExtraCompactVisualization2021** ï¼šYå”çš„ç¥åŒ…ï¼ŒåŸºäºggplot2è¯­æ³•ï¼Œå­¦èµ·æ¥æ¯”è¾ƒæµç•…ï¼Œæä¾›é«˜åº¦å¯å®šåˆ¶åŒ–çš„ç»˜å›¾ï¼Œæ”¯æŒå„ç§ä¸åŒç±»å‹çš„è¿›åŒ–æ ‘ã€‚æ˜¯æˆ‘ä»¬è¦è®²çš„é‡ç‚¹ï¼Œç”»æ ‘æŒæ¡è¿™ä¸¤ä¸ªåŒ…åŸºæœ¬å°±å¤Ÿäº†ã€‚[å®˜æ–¹è‹±æ–‡æ•™ç¨‹](https://yulab-smu.top/treedata-book/)ï¼›ç°åœ¨Yå”çš„ä¸­æ–‡æ•™ç¨‹ä¹Ÿåœ¨çƒ­å–ä¸­ã€‚

2.  apeï¼šæä¾›äº†ç”¨äºç»˜åˆ¶åŸºæœ¬çš„è¿›åŒ–æ ‘å’Œä¸€äº›ç®€å•çš„æ ‘çš„å¯è§†åŒ–å‡½æ•°ï¼ŒåŸºç¡€å‡½æ•°è¿˜æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œphyloå¯¹è±¡ä¹Ÿæ˜¯ä¸€ç›´è¦ç”¨çš„ã€‚

3.  phytoolsï¼šæä¾›äº†å¤šç§ç”¨äºç»˜åˆ¶è¿›åŒ–æ ‘çš„å‡½æ•°ï¼ŒåŒ…æ‹¬å˜å½¢è¿›åŒ–æ ‘çš„å‡½æ•°ã€‚

4.  ggphyloï¼šåŸºäºggplot2è¯­æ³•ï¼Œæä¾›äº†ä¸€äº›ç”¨äºç»˜åˆ¶è¿›åŒ–æ ‘çš„å‡½æ•°ï¼Œæ”¯æŒå¤šç§ä¸åŒçš„æ ‘å½¢æ€ã€‚

æˆ‘ä»¬å¯ä»¥å…ˆå®‰è£…è½½å…¥ä¸€äº›åŒ…ã€‚

```{r eval=FALSE}
if (!requireNamespace("BiocManager", quietly=TRUE))
    install.packages("BiocManager")
BiocManager::install("YuLab-SMU/treedataverse")
BiocManager::install("ggtree")
BiocManager::install("ggtreeExtra")


library(dplyr)
library(ggplot2)
library(treedataverse)
library(ggtree)
library(ggtreeExtra)
```

### format

é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯ä»‹ç»ä¸€ä¸‹å­˜å‚¨æ ‘çš„ä¸€äº›æ–‡ä»¶æ ¼å¼å’Œè¯»å–æ–¹æ³•ï¼ˆæ¯•ç«Ÿè¯»å…¥æ•°æ®ä¸€ç›´æ˜¯å¯è§†åŒ–çš„ç¬¬ä¸€æ­¥ï¼‰ã€‚

1.  Newickæ ¼å¼ (.newick æˆ– .nwk)ï¼šNewickæ ¼å¼æ˜¯æœ€å¸¸è§çš„ç”¨äºå­˜å‚¨å’Œä¼ è¾“ç³»ç»Ÿå‘è‚²æ ‘çš„æ ¼å¼ä¹‹ä¸€ã€‚å®ƒæ˜¯ä¸€ç§æ–‡æœ¬æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å’Œç¼–è¾‘ã€‚åœ¨Newickæ ¼å¼ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±ä¸€ä¸ªæ‹¬å·è¡¨ç¤ºï¼Œå…¶åé¢è·Ÿç€ä¸€ä¸ªè¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„æ ‡ç­¾å’Œä¸€ä¸ªå†’å·ï¼Œç„¶åæ˜¯ä¸€ä¸ªè¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„åˆ†æ”¯é•¿åº¦çš„æ•°å­—ï¼Œæœ€åè·Ÿç€é€—å·å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ‹¬å·ã€‚å¶èŠ‚ç‚¹æ˜¯æ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ã€‚

2.  Nexusæ ¼å¼ (.nex æˆ– .nexus)ï¼šNexusæ ¼å¼æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ç”¨äºå­˜å‚¨åˆ†å­ç³»ç»Ÿå‘è‚²æ ‘å’Œå…¶ä»–åˆ†å­ç”Ÿç‰©å­¦æ•°æ®çš„æ ¼å¼ã€‚å®ƒæ˜¯ä¸€ç§æ–‡æœ¬æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å’Œç¼–è¾‘ã€‚Nexusæ ¼å¼å…è®¸å­˜å‚¨å¤šä¸ªæ•°æ®é›†å’Œå¤šä¸ªæ ‘ï¼Œå¹¶æä¾›äº†ä¸€äº›å…¶ä»–çš„æ‰©å±•åŠŸèƒ½ï¼Œå¦‚æ³¨é‡Šã€åŒºåˆ†å­—ç¬¦ç­‰ã€‚

3.  PhyloXMLæ ¼å¼ (.xml)ï¼šPhyloXMLæ ¼å¼æ˜¯ä¸€ç§åŸºäºXMLçš„æ ¼å¼ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å’Œä¼ è¾“ç³»ç»Ÿå‘è‚²æ ‘ã€‚å®ƒæä¾›äº†è®¸å¤šå…¶ä»–æ ¼å¼æ‰€ä¸å…·å¤‡çš„çµæ´»æ€§å’Œæ‰©å±•æ€§ï¼Œå¯ä»¥å­˜å‚¨å¤§é‡çš„ä¿¡æ¯ï¼Œå¦‚èŠ‚ç‚¹æ³¨é‡Šã€æ”¯æŒå€¼ã€åˆ†æ”¯é•¿åº¦ã€æ”¯æŒç‡ç­‰ã€‚

4.  NeXMLæ ¼å¼ (.xml)ï¼šNeXMLæ ¼å¼æ˜¯ä¸€ç§åŸºäºXMLçš„æ ¼å¼ï¼Œç”¨äºå­˜å‚¨å’Œä¼ è¾“ç”Ÿç‰©å¤šæ ·æ€§å’Œç³»ç»Ÿå‘è‚²æ ‘æ•°æ®ã€‚å®ƒæä¾›äº†PhyloXMLæ ¼å¼çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶æ·»åŠ äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚å­˜å‚¨ç”Ÿç‰©å¤šæ ·æ€§å…ƒæ•°æ®ã€äº‹ä»¶ã€ä¼ è¾“ç½‘æ ¼æ•°æ®ç­‰ã€‚

5.  å…¶ä»–è¿˜æœ‰Phylip æ ¼å¼ (.phy æˆ– .phylip)ï¼ŒPAUP æ ¼å¼ (.paup)ï¼ŒIQ-TREE æ ¼å¼ (.tree)ï¼ŒRAxML æ ¼å¼ (.raxml)ï¼ŒMEGA æ ¼å¼ (.meg)ç­‰ç­‰ã€‚

åœ¨Rä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„åŒ…å’Œå‡½æ•°æ¥è¯»å–ä¸åŒæ ¼å¼çš„ç³»ç»Ÿå‘è‚²æ ‘æ–‡ä»¶ã€‚å¦‚ **`ape`** åŒ…ä¸­çš„ **`read.tree()`** å‡½æ•°å¯ä»¥è¯»å–Newickæ ¼å¼çš„ç³»ç»Ÿå‘è‚²æ ‘æ–‡ä»¶ã€ **`phangorn`** åŒ…ä¸­çš„ **`read.phyDat()`** å’Œ **`read.phylo()`** å‡½æ•°è¯»å–åŒ…æ‹¬Nexusã€Newickã€Phylipç­‰æ ¼å¼ã€‚

å½“ç„¶ï¼ŒYå”å›¢é˜Ÿä¹Ÿè´´å¿ƒåœ°å‡†å¤‡å¥½äº†ä¸€ä¸ªåŒ… **`treeio`** ç”¨äºè¯»å–ã€å¤„ç†å„ç§ç³»ç»Ÿå‘è‚²æ ‘æ–‡ä»¶æ ¼å¼ï¼š

```{r eval=FALSE}
library(treeio)
# ä» Newick æ ¼å¼è¯»å–ç³»ç»Ÿå‘è‚²æ ‘æ•°æ®
tree <- read.tree("tree.nwk")
# ä» Nexus æ ¼å¼è¯»å–ç³»ç»Ÿå‘è‚²æ ‘æ•°æ®
tree <- read.nexus("tree.nexus")
# ä» Phylip æ ¼å¼è¯»å–ç³»ç»Ÿå‘è‚²æ ‘æ•°æ®
tree <- read.phylo("tree.phy")

```

Nexusã€Newickã€Phylipè¿™å‡ ç§æ ¼å¼è¯»å…¥åä¼šå˜æˆå¸¸è§çš„**phylo S3å¯¹è±¡**ï¼Œå…¶ä»–æ ¼å¼è¯»å…¥åä¸€èˆ¬ä¼šå˜æˆ**treedata S4å¯¹è±¡**ï¼ˆæ›´é«˜çº§å…¨é¢çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå½“ç„¶äº¦å¯ä»¥å’Œphyloç›¸äº’è½¬æ¢ï¼‰ï¼Œè¿™ä¸¤ç§å¯¹è±¡éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ggtreeç”»å›¾çš„ï¼Œæˆ‘ä»¬åªè¦è¯»å…¥å°±å¥½ã€‚

### basic plot

```{r}
set.seed(1234)
#ç”Ÿæˆç¤ºä¾‹æ ‘
tree=rtree(50)

(main_p=ggtree(tree,
      mapping = NULL,
      layout = "rectangular",#å¸¸ç”¨circularï¼Œdaylight
      open.angle = 0,#éƒ¨åˆ†æ”¯æŒï¼Œå¦‚fan
      mrsd = NULL,#æ—¶é—´è½´
      as.Date = FALSE,
      yscale = "none",
      yscale_mapping = NULL,
      ladderize = TRUE,#é˜¶æ¢¯çŠ¶æ’åˆ—æ ‘
      right = FALSE,
      branch.length = "branch.length",#"none"å°±ä¼šè®©branchæœ«ç«¯éƒ½å¯¹é½
      root.position = 0,
      xlim = NULL,
      #çº¿æ®µé£æ ¼
      color="black", size=0.5, linetype=1))

```

#### layout

æ•´æ£µæ ‘çš„å¸ƒå±€æ–¹å¼æœ‰å¾ˆå¤š'rectangular', 'dendrogram', 'slanted', 'ellipse', 'roundrect', 'fan', 'circular', 'inward_circular', 'radial', 'equal_angle', 'daylight' or 'ape'ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶å®ƒä¸€äº›å‚æ•°è°ƒèŠ‚ï¼š

```{r layout,eval=FALSE}
ggtree(tree)
ggtree(tree, layout="roundrect")
ggtree(tree, layout="slanted")
ggtree(tree, layout="ellipse")

ggtree(tree, layout="circular")
ggtree(tree, layout="fan", open.angle=120)
ggtree(tree, layout="equal_angle")
ggtree(tree, layout="daylight")

ggtree(tree, branch.length='none')
ggtree(tree, layout="ellipse", branch.length="none")
ggtree(tree, layout='circular', branch.length='none')
ggtree(tree, layout="daylight", branch.length = 'none')

```

![](images/tree_layout1.svg){width="100%"}

```{r layout2,eval=FALSE}
ggtree(tree) + scale_x_reverse()#å·¦å³é¢ å€’
ggtree(tree) + coord_flip()#ä¸Šä¸‹é¢ å€’
ggtree(tree) + layout_dendrogram()#åªçœ‹éª¨æ¶

ggplotify::as.ggplot(ggtree(tree), angle=-30, scale=.9)#æ—‹è½¬ç‰¹å®šè§’åº¦å’Œç¼©æ”¾
ggtree(tree, layout='slanted') + coord_flip()
ggtree(tree, layout='slanted', branch.length='none') + layout_dendrogram()

ggtree(tree, layout='circular') + xlim(-10, NA)#æ‰©å¤§æ ‘ä¸­é—´çš„ç©ºç™½åŒºåŸŸ
ggtree(tree) + layout_inward_circular()#å†…å¤–é¢ å€’
ggtree(tree) + layout_inward_circular(xlim=15)
```

![](images/tree_layout2.svg){width="100%"}

#### label

```{r}
#å¯¹é½åŠ è™šçº¿
main_p+geom_tiplab(align = T,linetype = 3,linesize = 0.5,size=2,color="red")

#å¯¹é½ä¸åŠ è™šçº¿
main_p+geom_tiplab(align = F,size=4,color="blue",as_ylab = T)

#åŠ ä¸Šå†…éƒ¨èŠ‚ç‚¹åç§°
ggtree(tree)+geom_nodelab(mapping = aes(label=node))

#æ¯”ä¾‹å°º
main_p+geom_treescale(fontsize=6, linesize=1, offset=1, width=1, color='red')
```

### manipulate

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`tidytree::as_tibble`æˆ–è€…`ggtree::fortify`æŠŠæ•´ä¸ªæ ‘ï¼ˆphyloå¯¹è±¡ï¼‰è½¬ä¸ºä¸€ä¸ªæ˜“äºé˜…è¯»çš„dataframeã€‚

parentå’Œnodeä¸¤åˆ—å±•ç¤ºäº†æ•´ä¸ªæ ‘çš„è¿æ¥å…³ç³»,branch.lengthæ˜¯æ¯ä¸ªæï¼ˆè¿æ¥parentå’Œnodeï¼‰çš„æé•¿ï¼Œlabelæ˜¯nodeçš„labelï¼Œä¸€èˆ¬æ¯ä¸ªtipï¼ˆç«¯ç‚¹ï¼‰éƒ½ä¼šæœ‰ä¸€ä¸ªlabelï¼Œå†…éƒ¨çš„ç‚¹å¯èƒ½æ²¡æœ‰labelï¼ˆæ¯”å¦‚è¿™ä¸ªç¤ºä¾‹ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨åŠ ä¸Šã€‚

```{r}
tidytree::as_tibble(tree)%>%head()

tree_df=ggtree::fortify(tree)
head(tree_df)
```

æˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•è®¿é—®æ ‘çš„èŠ‚ç‚¹ï¼ˆnodeï¼‰çš„å…³ç³»èŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡treeæˆ–è€…treeç”Ÿæˆçš„dataframeæŸ¥è¯¢ï¼š

```{r}
library(tidytree)
child(tree, 53)#å­èŠ‚ç‚¹,ä¸€å±‚
parent(tree, 1)#çˆ¶èŠ‚ç‚¹ï¼Œä¸€å±‚

offspring(tree, 53)#æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
ancestor(tree, 1)#æ‰€æœ‰çš„çˆ¶èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬çˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹

sibling(tree, 1)#å…„å¼ŸèŠ‚ç‚¹

MRCA(tree, 1, 2)#æœ€è¿‘ç¥–å…ˆ
```

**èŠ‚ç‚¹åˆ†ç»„**

`groupOTU()` å’Œ `groupClade()` æ–¹æ³•æ—¨åœ¨å°†åˆ†ç±»ç¾¤åˆ†ç»„ä¿¡æ¯æ·»åŠ åˆ°è¾“å…¥æ ‘å¯¹è±¡ï¼Œè¿™ç§åˆ†ç»„ä¿¡æ¯å¯ä»¥ç›´æ¥ç”¨åœ¨ ggtree çš„æ ‘å¯è§†åŒ–ä¸­ã€‚

`groupOTU()` è¾“å…¥çš„æ˜¯è¦ç»™åˆ†ç»„ä¸‹çš„æ¯ä¸ªnodeã€‚

`groupClade()` è¾“å…¥ç»™æ¯ä¸ªåˆ†ç»„çš„æœ€é«˜çº§nodeå³å¯ï¼Œä¼šè‡ªåŠ¨åˆ†é…è¯¥nodeä¸‹æ‰€æœ‰offspring nodeåŒä¸€ä¸ªåˆ†ç»„ã€‚

```{r}
groupOTU(tree, .node = c(52,53),group_name = "OTU")%>%as_tibble()%>%head

groupClade(tree, .node = c(52,53),group_name = "Clade")%>%as_tibble()%>%head
```

**å–æ ‘çš„å­é›†**

```{r}
clade <- tree_subset(tree, node=53, levels_back=0) 
clade2 <- tree_subset(tree, node=53, levels_back=1) 

p1 <- ggtree(clade) + geom_tiplab() + xlim(0, 5) 
p2 <- ggtree(clade2, aes(color=group)) + geom_tiplab() +    xlim(0, 9) + 
    scale_color_manual(values=c("black", "red"))
p1+p2
```

å…¶ä»–ä¸€äº›æ“ä½œ:

```{r eval=FALSE}
#é‡è®¾æ ‘æ ¹,æŒ‡å®šå¤–ç±»ç¾¤
trda2 <- root(tree, outgroup = 104, edgelabel = TRUE)

#ç¼©æ”¾æ ‘æ
rescale_tree(tree, 'dN')

#åˆ é™¤tip
drop.tip(tree,1:5)
```

### annotation

#### tip annotation

è¿™ç±»æ³¨é‡Šæ–¹æ³•ä½¿ç”¨çš„æ³¨é‡Šæ•°æ®é›†åŸºæœ¬æ˜¯ä¸€åˆ—æ˜¯tipçš„nodeå·æˆ–labelï¼Œå…¶ä»–åˆ—ä¸ºæ³¨é‡Šæ•°æ®ï¼ˆåˆ†ç±»æ•°æ®/è¿ç»­æ•°å€¼æ•°æ®ï¼‰ï¼Œæ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªtipã€‚

ggtreeæœ¬èº«è‡ªå¸¦ä¸€äº›å®ç°tipæ³¨é‡Šï¼ˆæ·»åŠ çƒ­å›¾ç­‰å¯¹è±¡ï¼‰çš„åŠŸèƒ½ï¼ŒåŸºäºfacetä»¥åŠæ•°æ®å¯¹é½tipï¼š

```{r}
#ç”Ÿæˆæµ‹è¯•æ³¨é‡Šæ–‡ä»¶
anno=data.frame(row.names = tree$tip.label,node=tree$tip.label,
                Group=sample(LETTERS[1:3],50,replace = T),
                Type=sample(letters[1:3],50,replace = T),
                value1=abs(rnorm(50)),high=abs(rnorm(50,5)))
head(anno)

p=ggtree(tree)+geom_tiplab(align = T)

gheatmap(p, anno["Group"], offset=0, width=0.2)
```

æˆ–è€…ä½¿ç”¨aplotåŒ…è¿›è¡Œä¼šè‡ªåŠ¨å¯¹é½tipçš„ç»„å›¾ï¼ˆç”¨cowplotæ— æ³•å®ç°ï¼‰ï¼Œä½†ç¼ºç‚¹å°±æ˜¯ç»„å›¾æ—¶å€™çš„ä¸€äº›ç»†èŠ‚ä¸å¥½è°ƒèŠ‚ï¼Œä¸”è¦è€ƒè™‘æ¸…æ¥šå„ä¸ªåˆ†é¢insertçš„å…³ç³»å’Œå®½åº¦ã€‚

```{r}
library(aplot)
ap1=ggplot(anno,aes(x=node,y="Group",fill=Group))+geom_tile()+
    coord_flip() + theme_tree2() + theme(legend.position='none')
ap2=ggplot(anno,aes(x=node,y=high,fill=Group))+geom_col()+
    coord_flip() + theme_tree2() + theme(legend.position='none')
ap1%>% insert_left(p,width = 4) %>% insert_right(ap2, width=2) 

```

ç›®å‰æ„Ÿè§‰æœ€å¥½ç”¨çš„tipæ³¨é‡Šæ–¹æ³•å°±æ˜¯ **ggtreeExtra**ï¼Œæœ‰ç»Ÿä¸€çš„æ³¨é‡Šé€»è¾‘`geom_fruit`,æŒ‰ç…§å›¾å±‚ä¸€ä¸ªä¸€ä¸ªæ·»åŠ ï¼Œæ¯”è¾ƒæ˜“å­¦å’Œè°ƒèŠ‚ã€‚å…·ä½“èƒ½ç”¨æ¥æ³¨é‡Šçš„å›¾å±‚æœ‰'geom_bar', 'geom_col', 'geom_boxplot', 'geom_violin'ï¼Œ'ggstar','ggimage'ç­‰ã€‚

æ¯ä¸€ä¸ªgeomå›¾å±‚å°±åƒä¸€ä¸ªç§¯æœ¨å—ä¸€æ ·ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯æŒ‘é€‰åˆé€‚çš„ç§¯æœ¨ï¼Œç”¨åŒæ ·çš„æ–¹æ³•æ­ä¸Šå»å³å¯ï¼ˆä¹Ÿæ˜¯æ•´ä¸ªggplotçš„ç»˜å›¾é€»è¾‘ï¼Œä¼˜é›…ï¼‰ï¼Œå¯¹æ¯ä¸ªgeomå›¾å±‚ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä½¿ç”¨ggplotçš„å„ç§scaleæ–¹æ³•è°ƒèŠ‚é¢œè‰²ã€å¤§å°ã€å½¢çŠ¶ç­‰ã€‚

```{r}
p=ggtree(tree,layout = "fan")

#geom_star
library(ggstar)
p1=p + geom_fruit(
          data=anno,
          geom=geom_star,
          mapping=aes(y=`node`,fill=Type, size=value1, starshape=Group),
          position="identity",
          starstroke=0.1
      )+ 
    #è°ƒèŠ‚starçš„å¤§å°ä»¥åŠå…¶legend
      scale_size_continuous(
          range=c(1, 3), # the range of size.
          guide=guide_legend(
                    keywidth=0.5, 
                    keyheight=0.5,
                    override.aes=list(starshape=15),
                    order=2 #legendçš„é¡ºåº
                )
      ) +
    #è°ƒèŠ‚starçš„é¢œè‰²ä»¥åŠå…¶legend
      scale_fill_manual(
          values=c("#8dd3c7", "#ffed6f", "#bebada"),
          guide="none" 
      ) + 
     #è°ƒèŠ‚starçš„å½¢çŠ¶ä»¥åŠå…¶legend     
      scale_starshape_manual(
          values=c(1, 16,15),
          guide=guide_legend(
                    keywidth=0.5,
                    keyheight=0.5,
                    order=1
                )
      )
p1
```

è¦æ³¨æ„çš„æ˜¯ï¼åœ¨æ·»åŠ å¤šä¸ªå›¾å±‚æ—¶ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬è¦ç”¨å¤šæ¬¡çš„fillæˆ–colorå±æ€§ï¼Œä½†æ˜¯ggplotçš„scale_fill_manualä¼šå¯¹å…¨å±€ç”Ÿæ•ˆï¼Œç»“æœå°±ä¼šæ¯”è¾ƒå¥‡æ€ªï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å›¾å±‚ä¹‹é—´ä¸€èˆ¬è¦ä½¿ç”¨`ggnewscale`åŒ…æ¥äº§ç”Ÿä¸€ä¸ªæ–°çš„scaleï¼Œä¹‹åå°±å¯ä»¥åˆ†åˆ«è°ƒèŠ‚äº†ã€‚

```{r}
library(ggnewscale)
p2=p1 + 
      ggnewscale::new_scale_fill() + 
      geom_fruit(
          data=anno,
          geom=geom_tile,
          mapping=aes(y=node, fill=value1),
          offset=0.08,   # è°ƒèŠ‚
          pwidth=0.25 # width of the external layer, default is 0.2 times of x range of tree.
      ) + 
      scale_fill_gradient(low = "white",high = "red")

p2
```

```{r}
p2+ ggnewscale::new_scale_fill() +
      geom_fruit(
          data=anno,
          geom=geom_col,
          mapping=aes(y=node, x=high, fill=Type), 
          pwidth=0.4,offset = 0.1,
          axis.params=list(
                          axis="x", # æ·»åŠ xè½´æ–‡å­—
                          text.size=2, #æ–‡å­—å¤§å°
                          text.angle=-45, # è§’åº¦
                          hjust=0  # è°ƒèŠ‚
                      ),
          grid.params=list() # æ·»åŠ ç½‘æ ¼çº¿
      ) + 
      scale_fill_manual(
          values=c("#a6bce3", "#fb9a99", "#fdbf6f"),
          guide=guide_legend(keywidth=0.5, keyheight=0.5, order=6)
      )

```

å½“ç„¶è¿˜å¯ä»¥åŠ ä¸€äº›æœ‰è¶£çš„æ¯”å¦‚ **imageæ³¨é‡Š** ã€‚

```{r}
library(ggimage)
library(ggtree)

nwk <- paste0("((((bufonidae, dendrobatidae), ceratophryidae),",
              "(centrolenidae, leptodactylidae)), hylidae);")

imgdir <- system.file("extdata/frogs", package = "TDbook")

x = read.tree(text = nwk)

ggtree(x)+geom_tiplab()+
    geom_fruit(
        data = data.frame(node=x$tip.label,image=paste0(imgdir, '/', x$tip.label, '.jpg')),
        geom = geom_image,
        mapping = aes(y=node,image=image), offset=0.5, align=2, size=.2
    )
```

ç”Ÿç‰©å‰ªå½±ï¼Œ[Phylopic](https://yulab-smu.top/treedata-book/phylopic.org) åŒ…å« 3200 å¤šä¸ªç”Ÿç‰©å‰ªå½±ï¼Œæ¶µç›–å¾ˆå¤šé—¨ç±»ã€‚

```{r eval=FALSE}
newick <- paste0("((Pongo_abelii,(Gorilla_gorilla_gorilla,(Pan_paniscus,",
          "Pan_troglodytes)Pan,Homo_sapiens)Homininae)Hominidae,",
          "Nomascus_leucogenys)Hominoidea;")

tree <- read.tree(text=newick)
#é€šè¿‡phylopic_uidæŸ¥è¯¢å‰ªå½±
d <- ggimage::phylopic_uid(tree$tip.label)
d$body_mass <- c(52, 114, 47, 45, 58, 6)

p <- ggtree(tree) %<+% d + 
  geom_tiplab(aes(image=uid, colour=body_mass), geom="phylopic", offset=2.5) +
  geom_tiplab(aes(label=label), offset = .2) + xlim(NA, 7) +
  scale_color_viridis_c()
```

```{r echo=FALSE}
knitr::include_graphics("images/phylopic.png")
```

#### internal annotation

è¿™ç±»æ³¨é‡Šæ–¹æ³•ä½¿ç”¨åŸºæœ¬æ˜¯å†…éƒ¨çš„nodeå·æˆ–labelï¼ŒåŠ ä¸Šé¢å¤–çš„æ³¨é‡Šæ•°æ®ï¼ˆåˆ†ç±»æ•°æ®/è¿ç»­æ•°å€¼æ•°æ®ï¼‰

å¯é€‰çš„å¯¹è±¡æœ‰cladelabï¼Œstripï¼Œhighlightï¼Œtaxa_link... ä¹Ÿèƒ½ç›´æ¥ç»™ä¸€éƒ¨åˆ†æ ‘æä¸Šè‰²ã€‚

```{r}
internal_anno=data.frame(node=c(53,68,79),name=paste0("clade",1:3),angle1=c(0,90,0))

tree2 <- groupClade(tree, setNames(internal_anno$node,internal_anno$name),group_name = "test")

(col_p=ggtree(tree2, aes(color=test))+
  scale_color_manual(values=c("black", "red3", "skyblue","yellow3")) + 
    #theme(legend.position='none')+
    guides(color=guide_legend(override.aes = list(linewidth=3)))
)

#æ·»åŠ pointæ³¨é‡Š
ggtree(tree2, layout="fan") + 
  geom_point2(mapping = aes(subset=c(test!=0),color=test))

```

```{r}
ggtree(tree, layout="fan") + 
  geom_cladelab(data = internal_anno,mapping = aes(node=node,label=name,color=name,angle=angle1))

#stripç±»ä¼¼cladelabï¼Œä¸è¿‡æä¾›çš„æ˜¯ä¸¤ä¸ªtipï¼Œå¯ä»¥æ¨ªè·¨ä¸åŒä½ç½®çš„ææ¡,ä¸æ¥å—mapping
ggtree(tree, layout="fan")  + geom_tiplab() + 
  geom_strip('t10', 't33', barsize=2, color='red', 
            label="group1", offset.text=.1) + 
  geom_strip('t12', 't21', barsize=2, color='blue', 
            label = "group2", offset.text=.1)
```

```{r}
#highlight
ggtree(tree, layout="fan") + 
  geom_highlight(data = internal_anno,mapping = aes(node=node,label=name,fill=name))

#balanceç±»ä¼¼highlightï¼Œä¸è¿‡å¯ä»¥æä¾›ä¸¤ä¸ªæœ‰åŒ…å«å…³ç³»çš„clade,ä¸æ¥å—mapping
ggtree(tree) +
  geom_balance(node=55, fill='steelblue', alpha=0.6, extend=1) +
  geom_balance(node=56, fill='darkgreen',  alpha=0.6, extend=1) 

```

```{r}
links <-data.frame(from=c("t36","t7","t23"), 
                  to=c("t6", "t46", "t29"), 
                  type=c("l1", "l2", "l3"), 
                  s=c(2, 1, 2))
ggtree(tree, layout="inward_circular", xlim=c(30, 0)) +
          geom_taxalink(data=links, 
                         mapping=aes(taxa1=from, 
                                     taxa2=to, 
                                     color=type, 
                                     size=s)) + 
          geom_tiplab(hjust=1) +
          scale_size_continuous(range=c(1,3))
```

å¦å¤–ä¸€äº›æ˜¯é€šè¿‡å†…éƒ¨èŠ‚ç‚¹æ”¹å˜æ•´ä¸ªæ ‘åˆ†å¸ƒçš„æ–¹æ³•ï¼š

```{r}
#é€šè¿‡scaleCladeè°ƒèŠ‚æŸä¸ªcladeå æ¯”
scaleClade(col_p, node=53, scale=.1) 

#é€šè¿‡collapesæŠ˜å æŸä¸ªclade
collapse(col_p, node=53,mode = c("mix","max","min","none")[1],fill="red3",alpha=0.4)

#é€šè¿‡rotateæ—‹è½¬ä¸¤ä¸ªclade
ggtree::rotate(col_p,node = 52)+geom_nodelab(aes(subset=c(node==52),label=node))

#é€šè¿‡flipäº¤æ¢ä¸¤ä¸ªclade
ggtree::flip(col_p,53,68)+geom_nodelab(aes(label=node))

#é€šè¿‡open_treeå’Œrotate_treeè°ƒèŠ‚è§’åº¦
open_tree(col_p, 180)%>%rotate_tree(90)
```

æŒæ¡ä»¥ä¸Šè¿™äº›æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç»˜åˆ¶å‡ºç”¨åœ¨æ–‡ç« çš„æ ‘äº†ï¼ˆå½“ç„¶ä¸€å®šè¦è‡ªå·±å¥½å¥½æ‰¾é…è‰²ï¼Œè°ƒæ•´ç»†èŠ‚ï¼ï¼ï¼ï¼‰

ä¸‹æ¬¡è¿›é˜¶ï¼

## Reference
