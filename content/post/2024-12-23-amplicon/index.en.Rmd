---
title: æ‰©å¢å­(Amplicon)æ•°æ®åˆ†ææµç¨‹
author: Peng Chen
date: '2024-12-23'
slug: amplicon-workflow
categories:
  - metagenomic
tags:
  - 16S
  - amplicon
description: ~
image: images/16s.webp
math: ~
license: ~
hidden: no
comments: yes
---

```{r include=FALSE}
Packages <- c("dplyr","kableExtra","ggplot2")
pcutils::lib_ps(Packages)
knitr::opts_chunk$set(message = FALSE,warning = FALSE,eval = FALSE)
```


## Introduction

æˆ‘å­¦ä¹ å¾®ç”Ÿç‰©ç»„åˆ†æçš„è¿‡ç¨‹æ˜¯ä»shot-gun å®åŸºå› ç»„æ•°æ®åˆ†æå¼€å§‹çš„ï¼Œåè€Œæ²¡æ€ä¹ˆåšè¿‡ç›¸å¯¹æ›´æ—©æ›´æˆç†Ÿçš„æ‰©å¢å­æµ‹åºçš„ä¸Šæ¸¸åˆ†æğŸ˜‚ï¼Œæœ€è¿‘åˆšå¥½æœ‰éœ€æ±‚ï¼Œè¿˜æ˜¯è‡ªå·±å­¦ä¹ å¹¶æ­å»ºä¸€ä¸‹è‡ªå·±ç”¨çš„æ¯”è¾ƒèˆ’æœçš„æµç¨‹å§ã€‚

æ‰©å¢å­ï¼ˆAmpliconï¼‰åˆ†ææ˜¯ç ”ç©¶å¾®ç”Ÿç‰©ç¾¤è½ç»„æˆä¸åŠŸèƒ½çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”Ÿæ€å­¦ã€åŒ»å­¦å’Œç¯å¢ƒç§‘å­¦é¢†åŸŸã€‚é€šè¿‡å¯¹ç›®æ ‡åŸºå› åŒºåŸŸï¼ˆå¦‚16S rRNAã€18S rRNAã€ITSï¼‰çš„ç‰¹å¼‚æ€§æ‰©å¢ä¸æµ‹åºï¼Œæ‰©å¢å­åˆ†æèƒ½å¤Ÿé«˜æ•ˆæ­ç¤ºæ ·æœ¬ä¸­å¾®ç”Ÿç‰©çš„å¤šæ ·æ€§å’Œç¾¤è½ç»“æ„ã€‚ç›¸æ¯”å®åŸºå› ç»„æµ‹åºï¼Œæ‰©å¢å­åˆ†æå…·æœ‰æˆæœ¬ä½ã€å¤„ç†æµç¨‹ç®€åŒ–ç­‰ä¼˜åŠ¿ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡æ ·æœ¬ç ”ç©¶ã€‚

æ‰©å¢å­åˆ†æçš„æ ¸å¿ƒåŸç†æ˜¯é€šè¿‡èšåˆé…¶é“¾å¼ååº” (PCR) æŠ€æœ¯ï¼Œå¯¹ç›®æ ‡å¾®ç”Ÿç‰©åŸºå› ç‰‡æ®µè¿›è¡Œç‰¹å¼‚æ€§æ‰©å¢å’Œæµ‹åºï¼Œä»¥è§£æå¾®ç”Ÿç‰©ç¾¤è½ç»„æˆåŠå…¶å¤šæ ·æ€§ã€‚é€šå¸¸é€‰æ‹©çš„ç›®æ ‡ç‰‡æ®µä¸ºå…·æœ‰ä¿å®ˆåŒºåŸŸå’Œé«˜å˜å¼‚åŒºåŸŸçš„åŸºå› ï¼Œå¦‚ç»†èŒçš„16S rRNAåŸºå› ã€çœŸèŒçš„ITSåŒºç­‰ã€‚ä¿å®ˆåŒºåŸŸç”¨ä½œå¼•ç‰©è®¾è®¡çš„é¶ç‚¹ï¼Œé«˜å˜å¼‚åŒºåŸŸç”¨äºåŒºåˆ†ä¸åŒç‰©ç§ã€‚

å…·ä½“æ­¥éª¤åŒ…æ‹¬ï¼š
1. DNA æå–ï¼šä»æ ·æœ¬ä¸­æå–æ€» DNAã€‚
2. ç›®æ ‡åŸºå› æ‰©å¢ï¼šä½¿ç”¨ç‰¹å¼‚æ€§å¼•ç‰©æ‰©å¢ç›®æ ‡åŒºåŸŸã€‚
3. é«˜é€šé‡æµ‹åºï¼šæµ‹åºå¾—åˆ°å¤§é‡æ‰©å¢å­çš„åºåˆ—æ•°æ®ã€‚
4. ç”Ÿç‰©ä¿¡æ¯å­¦åˆ†æï¼šå¯¹åºåˆ—è¿›è¡Œè¿‡æ»¤ã€èšç±»ã€æ³¨é‡Šï¼Œè·å¾—ç‰©ç§åˆ†ç±»å’ŒåŠŸèƒ½ä¿¡æ¯ã€‚

è¿™ç§æ–¹æ³•çš„ä¼˜åŠ¿åœ¨äºå…¶é«˜çµæ•åº¦å’Œç‰¹å¼‚æ€§ï¼Œå¯ä»¥å¿«é€Ÿæ­ç¤ºå¾®ç”Ÿç‰©å¤šæ ·æ€§å¹¶è¿›è¡Œå®šé‡åˆ†æã€‚

### ç»†èŒ  
ç»†èŒæ ¸ç³–ä½“RNA (rRNA) åŒ…æ‹¬ 5S rRNA (120bp)ã€16S rRNA (~1540bp) å’Œ 23S rRNA (~2900bp)ã€‚  
- **5S rRNA**: åºåˆ—çŸ­ï¼Œé—ä¼ ä¿¡æ¯é‡æœ‰é™ï¼Œæ— æ³•ç”¨äºåˆ†ç±»é‰´å®šã€‚  
- **23S rRNA**: åºåˆ—è¿‡é•¿ï¼Œçªå˜ç‡é«˜ï¼Œä¸é€‚ç”¨äºè¿œç¼˜ç§ç±»åˆ†æã€‚  
- **16S rRNA**: ç¨³å®šæ€§é«˜ã€æ‹·è´æ•°å¤šï¼Œçº¦å ç»†èŒRNAæ€»é‡çš„80%ï¼ŒåŸºå› ä¸­åŒ…å«10ä¸ªä¿å®ˆåŒºå’Œ9ä¸ªé«˜å˜å¼‚åŒºï¼Œé€‚åˆç»†èŒåˆ†ç±»æ ‡å‡†ã€‚V3-V4 åŒºå› ç‰¹å¼‚æ€§å’Œæ•°æ®åº“æ”¯æŒæœ€ä½³ï¼Œå¸¸ç”¨äºå¤šæ ·æ€§åˆ†æã€‚  

![](images/16s.webp)

### çœŸæ ¸ç”Ÿç‰©  
çœŸæ ¸å¾®ç”Ÿç‰©çš„ rRNA åŒ…æ‹¬ 5.8Sã€18S å’Œ 28S rRNAï¼Œå…¶ä¸­ 18S rRNA å¸¸ç”¨äºå¤šæ ·æ€§åˆ†æã€‚  
- **18S rRNA**: åŸºå› åºåˆ—åŒ…æ‹¬ä¿å®ˆåŒºå’Œå¯å˜åŒº (V1-V9, æ—  V6)ã€‚å¯å˜åŒºåæ˜ ç‰©ç§å·®å¼‚ï¼ŒV4 åŒºå› åˆ†ç±»æ•ˆæœä½³ã€æ•°æ®åº“æ”¯æŒä¸°å¯Œï¼Œæ˜¯åˆ†æå’Œæ³¨é‡Šçš„æœ€ä½³é€‰æ‹©ã€‚  

### çœŸèŒ  
**ITS (å†…æºè½¬å½•é—´éš”åŒº)** ä½äºçœŸèŒ 18Sã€5.8S å’Œ 28S rRNA åŸºå› ä¹‹é—´ï¼Œç”± ITS1 å’Œ ITS2 ç»„æˆï¼Œåˆ†åˆ«é•¿çº¦ 350 bp å’Œ 400 bpã€‚  
- **ä¿å®ˆæ€§**: åŸºå› ç‰‡æ®µåœ¨ç§å†…ç¨³å®šï¼Œç§é—´å·®å¼‚æ˜¾è‘—ï¼Œé€‚ç”¨äºç»†ç²’åº¦åˆ†ç±»ã€‚  
- **çµæ´»æ€§**: å®¹æ˜“åˆ†æå’Œæ‰©å¢ï¼Œå¹¿æ³›ç”¨äºçœŸèŒç§å±å’ŒèŒæ ªç³»ç»Ÿå‘è‚²ç ”ç©¶ã€‚  

### å¤èŒ  
å¤èŒç”Ÿæ´»äºæç«¯ç¯å¢ƒï¼Œæ˜¯ç”Ÿå‘½æé™çš„ä»£è¡¨ã€‚é€šè¿‡å¼•ç‰©è®¾è®¡ï¼Œ16S rRNA çš„ V4V5 åŒºæ˜¯å¤èŒå¤šæ ·æ€§ç ”ç©¶çš„æ ¸å¿ƒåŒºåŸŸã€‚  
- **Illumina MiSeq**: 519F/915R é€‚ç”¨äº V4V5 æ‰©å¢ã€‚  
- **Roche 454**: 344F/915R è¡¨ç°æ›´ä½³ã€‚  
å¤èŒç ”ç©¶æ­ç¤ºäº†å…¶ç‹¬ç‰¹çš„ç”Ÿç‰©ç‰¹å¾ï¼Œä¿ƒè¿›äº†æç«¯ç”Ÿæ€å­¦å’Œç”Ÿç‰©ç³»ç»Ÿå­¦çš„å‘å±•ã€‚

## preprocess

ä¸€èˆ¬æŠŠæ‰€æœ‰æ ·æœ¬çš„æµ‹åºåŒç«¯æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªdataæ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åæŠŠæ‰€æœ‰æ ·æœ¬åå†™å…¥åˆ°ä¸€ä¸ª`samplelist`æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿åç»­å„ç§è½¯ä»¶çš„æ‰¹é‡æ“ä½œã€‚

### è´¨æ§ï¼šfastp

æµ‹åºæ–‡ä»¶è´¨æ§æ˜¯æŒ‡åœ¨ä¸‹æ¸¸åˆ†æå‰å¯¹æµ‹åºæ•°æ®è¿›è¡Œè´¨é‡æ§åˆ¶å’Œæ¸…ç†ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚

fastpæ˜¯ä¸€ä¸ªéå¸¸å¿«é€Ÿã€å¤šåŠŸèƒ½çš„æµ‹åºæ•°æ®è´¨æ§å·¥å…·ï¼Œæ”¯æŒè‡ªåŠ¨åŒ–çš„è´¨æ§å¤„ç†ï¼ŒåŒ…æ‹¬å»é™¤ä½è´¨é‡åºåˆ—ã€å‰ªåˆ‡æ¥å¤´åºåˆ—å’Œç”Ÿæˆè´¨æ§æŠ¥å‘Šã€‚

```{bash}
#!/bin/bash
#SBATCH --job-name=fastp
#SBATCH --output=/share/home/jianglab/pengchen/work/asthma/log/%x_%A_%a.out
#SBATCH --error=/share/home/jianglab/pengchen/work/asthma/log/%x_%A_%a.err
#SBATCH --array=1
#SBATCH --partition=cpu
#SBATCH --cpus-per-task=8
#SBATCH --mem-per-cpu=2G
samplelist=/share/home/jianglab/pengchen/work/asthma/samplelist

echo start: `date +"%Y-%m-%d %T"`
start=`date +%s`

####################
echo "SLURM_ARRAY_TASK_ID: " $SLURM_ARRAY_TASK_ID
START=$SLURM_ARRAY_TASK_ID

NUMLINES=40 #how many sample in one array

STOP=$((SLURM_ARRAY_TASK_ID*NUMLINES))
START="$(($STOP - $(($NUMLINES - 1))))"

echo "START=$START"
echo "STOP=$STOP"

####################
for (( N = $START; N <= $STOP; N++ ))
do
  sample=$(head -n "$N" $samplelist | tail -n 1)
  echo $sample
  mkdir -p data/fastp
  ~/miniconda3/envs/waste/bin/fastp -w 8 -i data/rawdata/${sample}_f1.fastq.gz -o data/fastp/${sample}_1.fq.gz \
    -I data/rawdata/${sample}_r2.fastq.gz -O data/fastp/${sample}_2.fq.gz -j data/fastp/${i}.json
done

##############
echo end: `date +"%Y-%m-%d %T"`
end=`date +%s`
echo TIME:`expr $end - $start`s
```

fastpçš„jsonæ–‡ä»¶ä¸­ç»Ÿè®¡äº†æµ‹åºæ•°æ®çš„åŸºæœ¬æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æ•´ç†ä¸ºè¡¨æ ¼ï¼š
æŠŠæ‰€æœ‰çš„.jsonæ–‡ä»¶ç§»åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œreport/ä¸‹ï¼Œä½¿ç”¨æˆ‘å†™çš„RåŒ…`pctax`è¯»å–jsonæ–‡ä»¶å¹¶æ•´ç†æˆè¡¨æ ¼ï¼š

```{r}
pctax::pre_fastp("report/")
```

### æ‹¼æ¥ï¼šFLASH

FLASHçš„å…¨ç§°ä¸ºFast Length Adjustment of Short readsã€‚å¦‚æœä¸¤æ¡readsçš„æ€»é•¿å¤§äºåŸå§‹æµ‹åºç‰‡æ®µçš„é•¿åº¦å°±å¯ä»¥ä½¿ç”¨flashè¿›è¡Œè¿æ¥ã€‚


```{bash}
flash data/fastp/${sample}_1.fq.gz data/fastp/${sample}_1.fq.gz -o data/clean_data/${sample}

vsearch --fastq_mergepairs data/fastp/${sample}_1.fq.gz --reverse data/fastp/${sample}_2.fq.gz --fastqout data/clean_data/${sample}.merged.fq --relabel ${sample}
``` 


```{bash}

```


ä½¿ç”¨fastp[2]ï¼ˆhttps://github.com/OpenGene/fastpï¼Œversion 0.19.6ï¼‰è½¯ä»¶å¯¹åŒç«¯åŸå§‹æµ‹åºåºåˆ—è¿›è¡Œè´¨æ§ï¼Œä½¿ç”¨FLASH[3]ï¼ˆhttp://www.cbcb.umd.edu/software/flashï¼Œversion 1.2.11ï¼‰è½¯ä»¶è¿›è¡Œæ‹¼æ¥ï¼š
ï¼ˆ1ï¼‰è¿‡æ»¤readså°¾éƒ¨è´¨é‡å€¼20ä»¥ä¸‹çš„ç¢±åŸºï¼Œè®¾ç½®50bpçš„çª—å£ï¼Œå¦‚æœçª—å£å†…çš„å¹³å‡è´¨é‡å€¼ä½äº20ï¼Œä»çª—å£å¼€å§‹æˆªå»åç«¯ç¢±åŸºï¼Œè¿‡æ»¤è´¨æ§å50bpä»¥ä¸‹çš„readsï¼Œå»é™¤å«Nç¢±åŸºçš„readsï¼›
ï¼ˆ2ï¼‰æ ¹æ®PE readsä¹‹é—´çš„overlapå…³ç³»ï¼Œå°†æˆå¯¹readsæ‹¼æ¥(merge)æˆä¸€æ¡åºåˆ—ï¼Œæœ€å°overlapé•¿åº¦ä¸º10bpï¼›
ï¼ˆ3ï¼‰æ‹¼æ¥åºåˆ—çš„overlapåŒºå…è®¸çš„æœ€å¤§é”™é…æ¯”ç‡ä¸º0.2ï¼Œç­›é€‰ä¸ç¬¦åˆåºåˆ—ï¼›
ï¼ˆ4ï¼‰æ ¹æ®åºåˆ—é¦–å°¾ä¸¤ç«¯çš„barcodeå’Œå¼•ç‰©åŒºåˆ†æ ·å“ï¼Œå¹¶è°ƒæ•´åºåˆ—æ–¹å‘ï¼Œbarcodeå…è®¸çš„é”™é…æ•°ä¸º0ï¼Œæœ€å¤§å¼•ç‰©é”™é…æ•°ä¸º2ã€‚

åŸºäºé»˜è®¤å‚æ•°ï¼Œä½¿ç”¨Qiime2æµç¨‹[10]ä¸­çš„DADA2[4]æ’ä»¶ï¼ˆæˆ–Deblur[5]æ’ä»¶ï¼‰å¯¹è´¨æ§æ‹¼æ¥ä¹‹åçš„ä¼˜åŒ–åºåˆ—è¿›è¡Œé™å™ªå¤„ç†ã€‚DADA2ï¼ˆæˆ–Deblurï¼‰é™å™ªå¤„ç†ä¹‹åçš„åºåˆ—é€šå¸¸è¢«ç§°ä¸ºASVsï¼ˆå³æ‰©å¢å­åºåˆ—å˜ä½“ï¼‰ã€‚å»é™¤æ‰€æœ‰æ ·å“ä¸­æ³¨é‡Šåˆ°å¶ç»¿ä½“å’Œçº¿ç²’ä½“åºåˆ—ã€‚ä¸ºäº†å°½é‡å‡å°‘æµ‹åºæ·±åº¦å¯¹åç»­Alphaå¤šæ ·æ€§å’ŒBetaå¤šæ ·æ€§æ•°æ®åˆ†æçš„å½±å“ï¼Œå°†æ‰€æœ‰æ ·æœ¬åºåˆ—æ•°æŠ½å¹³è‡³20,000ï¼ŒæŠ½å¹³åï¼Œæ¯ä¸ªæ ·æœ¬çš„å¹³å‡åºåˆ—è¦†ç›–åº¦ï¼ˆGoodâ€™s coverageï¼‰ä»å¯è¾¾99.09%ã€‚åŸºäºSliva 16S rRNAåŸºå› æ•°æ®åº“ï¼ˆv 138ï¼‰ï¼Œä½¿ç”¨Qiime2ä¸­çš„Naive bayes(æˆ–Vsearchã€æˆ–Blast)åˆ†ç±»å™¨å¯¹ASVsè¿›è¡Œç‰©ç§åˆ†ç±»å­¦åˆ†æã€‚ä½¿ç”¨PICRUSt2[9](version 2.2.0)è½¯ä»¶è¿›è¡Œ16SåŠŸèƒ½é¢„æµ‹åˆ†æã€‚


QIIME2ï¼Œé™å™ªæ–¹æ³•æ˜¯DADA2ï¼Œæ³¨é‡Šæ–¹æ³•æ˜¯ç‰©ç§æ³¨é‡Šæ–¹æ³•: classify-sklearnï¼ˆNaive Bayesï¼‰ï¼Œæ•°æ®åº“æ˜¯unite9.0


