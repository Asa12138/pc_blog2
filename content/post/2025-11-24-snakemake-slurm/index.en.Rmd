---
title: Snakemakeå…¥é—¨å’Œæ­é…Slurmä½¿ç”¨
author: Chen Peng
date: '2025-11-24'
slug: snakemake-slurm
categories:
  - utils
tags:
  - python
  - slurm
description: å­¦ä¹ Snakemakeå…¥é—¨å’Œæ­é…Slurmä½¿ç”¨
image: images/snakemaker.png
math: ~
license: ~
hidden: no
comments: yes
---

## Introduction

åœ¨æ—¥å¸¸ç”Ÿä¿¡ç§‘ç ”ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼š

- ä½ èŠ±ä¸€å‘¨æ—¶é—´è·‘å®Œä¸€å¥— RNA-seq æµç¨‹ï¼Œç»“æœå®¡ç¨¿äººè¦æ±‚æ¢ä¸€ä¸ªå‚è€ƒåŸºå› ç»„ï¼›
- åˆä½œè€…è¯´â€œä½ çš„è„šæœ¬åœ¨æˆ‘æœåŠ¡å™¨ä¸Šè·‘ä¸é€šâ€ï¼›
- ä½ ä¸æ•¢åˆ ä¸­é—´æ–‡ä»¶ï¼Œå› ä¸ºä¸çŸ¥é“å“ªä¸ªæ­¥éª¤ä¼šç”¨åˆ°ï¼›
- æƒ³å¹¶è¡Œè·‘ 100 ä¸ªæ ·æœ¬ï¼Œä½†æ‰‹åŠ¨æäº¤ 100 ä¸ªä½œä¸šå¤ªç—›è‹¦â€¦â€¦

è¿™äº›é—®é¢˜çš„æ ¹æºåœ¨äºï¼š**ä¼ ç»Ÿ shell è„šæœ¬ç¼ºä¹å¯¹ä»»åŠ¡ä¾èµ–ã€ç¯å¢ƒéš”ç¦»ã€æ‰§è¡Œè°ƒåº¦çš„æŠ½è±¡èƒ½åŠ›**ã€‚

![](images/snakemaker.png)

è€Œ **Snakemake** æ­£æ˜¯ä¸ºè§£å†³è¿™äº›ç—›ç‚¹è€Œè®¾è®¡çš„ç°ä»£å·¥ä½œæµç³»ç»Ÿã€‚å®ƒç”±å¾·å›½æœå¡å°”å¤šå¤«å¤§å­¦ Johannes KÃ¶ster å›¢é˜Ÿå¼€å‘ï¼Œè‡ª 2012 å¹´å‘å¸ƒä»¥æ¥ï¼Œå·²æˆä¸ºç”Ÿç‰©ä¿¡æ¯å­¦é¢†åŸŸäº‹å®ä¸Šçš„æ ‡å‡†ä¹‹ä¸€ã€‚

> âœ… **æ ¸å¿ƒä¼˜åŠ¿**ï¼š
> - **å£°æ˜å¼è¯­æ³•**ï¼šä½ åªéœ€æè¿°â€œè¾“å…¥æ˜¯ä»€ä¹ˆã€è¾“å‡ºæ˜¯ä»€ä¹ˆâ€ï¼Œä¸ç”¨å…³å¿ƒæ‰§è¡Œé¡ºåº
> - **è‡ªåŠ¨è·³è¿‡å·²å®Œæˆæ­¥éª¤**ï¼šä¿®æ”¹æŸä¸€æ­¥åï¼Œåªé‡è·‘å—å½±å“çš„éƒ¨åˆ†
> - **åŸç”Ÿæ”¯æŒ Conda**ï¼šæ¯ä¸ªæ­¥éª¤ç»‘å®šç‹¬ç«‹è½¯ä»¶ç¯å¢ƒ
> - **æ— ç¼å¯¹æ¥ HPC/äº‘å¹³å°**ï¼šSlurmã€PBSã€DRMAAã€Kubernetes ç­‰
> - **è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š**ï¼šå« DAG å›¾ã€è½¯ä»¶ç‰ˆæœ¬ã€æ•°æ®è¡€ç¼˜

---

## Snakemake æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 1. Snakefileï¼šæµç¨‹çš„â€œè“å›¾â€

æ‰€æœ‰è§„åˆ™å†™åœ¨ä¸€ä¸ªåä¸º `Snakefile` çš„æ–‡ä»¶ä¸­ï¼ˆæ— éœ€åç¼€ï¼‰ï¼Œä½¿ç”¨ Python è¯­æ³•å­é›†ã€‚

### 2. Ruleï¼ˆè§„åˆ™ï¼‰

æ¯ä¸ª `rule` å®šä¹‰ä¸€ä¸ªè®¡ç®—å•å…ƒï¼š

```python
rule my_task:
    input:
        "data/input.txt"
    output:
        "results/output.txt"
    conda:
        "envs/my_env.yaml"
    threads: 4
    resources:
        mem_mb=8000,
        runtime=60  # åˆ†é’Ÿ
    shell:
        "my_tool --threads {threads} --mem {resources.mem_mb} -i {input} -o {output}"
```

- `{input}`ã€`{output}`ã€`{threads}` ç­‰ä¼šè¢«è‡ªåŠ¨æ›¿æ¢
- `conda` æŒ‡å‘ä¸€ä¸ª YAML ç¯å¢ƒæ–‡ä»¶ï¼Œç¡®ä¿å·¥å…·ç‰ˆæœ¬ä¸€è‡´

### 3. Wildcardï¼ˆé€šé…ç¬¦ï¼‰

ç”¨ `{sample}`ã€`{group}` ç­‰å ä½ç¬¦å®ç°â€œæ³›åŒ–è§„åˆ™â€ï¼š

```python
rule align:
    input:
        fastq="data/{sample}.fastq",
        ref="genome.fa"
    output:
        "aligned/{sample}.bam"
```

å½“ç›®æ ‡æ˜¯ `aligned/A.bam` æ—¶ï¼ŒSnakemake è‡ªåŠ¨å°† `{sample}` æ›¿æ¢ä¸º `A`ã€‚

### 4. Dependency Graphï¼ˆä¾èµ–å›¾ï¼‰

Snakemake æ ¹æ® output â†’ input çš„é“¾æ¡ï¼Œè‡ªåŠ¨ç”Ÿæˆæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ã€‚ä¾‹å¦‚ï¼š

```
plot_quals â† call_variants â† sort_alignments â† map_reads
```

å®ƒä¼šæ™ºèƒ½åˆ¤æ–­å“ªäº›ä»»åŠ¡å·²å­˜åœ¨ã€å“ªäº›éœ€è¦è¿è¡Œã€‚

### 5. temp() ä¸ directory()

- `temp("file.bam")`ï¼šæ ‡è®°ä¸ºä¸´æ—¶æ–‡ä»¶ï¼Œåç»­ä¸å†éœ€è¦æ—¶è‡ªåŠ¨åˆ é™¤
- `directory("results/")`ï¼šæ ‡è®°ä¸ºç›®å½•è¾“å‡ºï¼ˆé¿å…è¯¯åˆ¤ï¼‰

---

## å®æˆ˜ï¼šæ„å»ºä¸€ä¸ª WGS å˜å¼‚æ£€æµ‹æµç¨‹

å¤ç° [Snakemake å®˜æ–¹çŸ­æ•™ç¨‹](https://snakemake.readthedocs.io/en/v7.20.0/tutorial/short.html)ï¼ŒåŠ å…¥æ›´è¯¦ç»†çš„è§£é‡Šã€‚

### ç¬¬ 0 æ­¥ï¼šå‡†å¤‡æ•°æ®

```bash
mkdir snakemake-wgs && cd snakemake-wgs
wget https://github.com/snakemake/snakemake-tutorial-data/archive/v5.4.5.tar.gz
tar -xzf v5.4.5.tar.gz --strip-components=1 "snakemake-tutorial-data-5.4.5/data"
```

å¾—åˆ°ï¼š
```
data/
â”œâ”€â”€ genome.fa          # å‚è€ƒåŸºå› ç»„
â””â”€â”€ samples/
    â”œâ”€â”€ A.fastq
    â”œâ”€â”€ B.fastq
    â””â”€â”€ C.fastq
```

### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºé¡¹ç›®ç»“æ„

```bash
mkdir -p workflow envs notebooks report results/calls results/mapped results/plots
touch workflow/Snakefile
```

### ç¬¬ 2 æ­¥ï¼šç¼–å†™ Snakefileï¼ˆé€è¡Œè§£æï¼‰

```python
# workflow/Snakefile

# å®šä¹‰æ ·æœ¬åˆ—è¡¨ï¼ˆå®é™…é¡¹ç›®å»ºè®®ç”¨ config.yamlï¼‰
SAMPLES = ["A", "B", "C"]

# é»˜è®¤ç›®æ ‡ï¼šç¬¬ä¸€ä¸ª rule æ˜¯å…¥å£ç‚¹
rule all:
    input:
        "results/calls/all.vcf",
        "results/plots/quals.svg"

# æ­¥éª¤1ï¼šæ¯”å¯¹ reads åˆ°å‚è€ƒåŸºå› ç»„
rule map_reads:
    input:
        ref="data/genome.fa",
        reads="data/samples/{sample}.fastq"
    output:
        temp("results/mapped/{sample}.bam")  # ä¸´æ—¶æ–‡ä»¶
    conda:
        "envs/mapping.yaml"   # æŒ‡å®š Conda ç¯å¢ƒ
    threads: 8                # å£°æ˜éœ€è¦ 8 çº¿ç¨‹
    shell:
        # ä½¿ç”¨ {threads} åŠ¨æ€ä¼ å‚
        "bwa mem -t {threads} {input.ref} {input.reads} | "
        "samtools view -b - > {output}"

# æ­¥éª¤2ï¼šæ’åº BAM
rule sort_alignments:
    input:
        "results/mapped/{sample}.bam"
    output:
        "results/mapped/{sample}.sorted.bam"
    conda:
        "envs/mapping.yaml"
    shell:
        "samtools sort -o {output} {input}"

# æ­¥éª¤3ï¼šè”åˆå˜å¼‚æ£€æµ‹ï¼ˆèšåˆæ‰€æœ‰æ ·æœ¬ï¼‰
rule call_variants:
    input:
        fa="data/genome.fa",
        bam=expand("results/mapped/{sample}.sorted.bam", sample=SAMPLES)
    output:
        "results/calls/all.vcf"
    conda:
        "envs/calling.yaml"
    shell:
        "bcftools mpileup -f {input.fa} {input.bam} | "
        "bcftools call -mv - > {output}"

# æ­¥éª¤4ï¼šç”¨ Python ç”»è´¨é‡åˆ†å¸ƒå›¾
rule plot_quals:
    input:
        "results/calls/all.vcf"
    output:
        report("results/plots/quals.svg", caption="report/calling.rst")
    conda:
        "envs/stats.yaml"
    notebook:
        "notebooks/plot-quals.py.ipynb"
```

> ğŸ” **å…³é”®ç‚¹è¯´æ˜**ï¼š
> - `expand()` å‡½æ•°å±•å¼€æ‰€æœ‰æ ·æœ¬è·¯å¾„
> - `report()` æ ‡è®°æ–‡ä»¶ç”¨äºç”Ÿæˆ HTML æŠ¥å‘Š
> - `notebook` æ”¯æŒ `.py` æˆ– `.ipynb`ï¼ŒSnakemake ä¼šè‡ªåŠ¨æ³¨å…¥ `snakemake.input/output`

### ç¬¬ 3 æ­¥ï¼šåˆ›å»º Conda ç¯å¢ƒæ–‡ä»¶

```yaml
# envs/mapping.yaml
channels:
  - bioconda
  - conda-forge
dependencies:
  - bwa=0.7.17
  - samtools=1.9
```

```yaml
# envs/calling.yaml
channels:
  - bioconda
  - conda-forge
dependencies:
  - bcftools=1.9
```

```yaml
# envs/stats.yaml
channels:
  - bioconda
  - conda-forge
dependencies:
  - python=3.9
  - pysam=0.17
  - pandas=1.3
  - altair=4.1
  - altair_saver=0.5
```

### ç¬¬ 4 æ­¥ï¼šç”Ÿæˆç»˜å›¾è„šæœ¬

```bash
snakemake --draft-notebook results/plots/quals.svg --use-conda --cores 1
```

ç¼–è¾‘ `notebooks/plot-quals.py.ipynb`ï¼Œæ·»åŠ ï¼š

```python
import pandas as pd
import altair as alt
from pysam import VariantFile

quals = pd.DataFrame({
    "qual": [record.qual for record in VariantFile(snakemake.input[0])]
})

chart = alt.Chart(quals).mark_bar().encode(
    alt.X("qual:Q", bin=True),
    alt.Y("count()")
)
chart.save(snakemake.output[0])
```

### ç¬¬ 5 æ­¥ï¼šæœ¬åœ°è¿è¡Œä¸éªŒè¯

```bash
# å¹²è·‘ï¼šæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
snakemake --use-conda -n

# å®é™…è¿è¡Œï¼ˆé™åˆ¶ 4 æ ¸ï¼‰
snakemake --use-conda --cores 4

# å¼ºåˆ¶é‡è·‘æŸä¸€æ­¥
snakemake --use-conda --forceall results/plots/quals.svg

# ç”Ÿæˆäº¤äº’å¼ HTML æŠ¥å‘Š
snakemake --report report.html
```

æ‰“å¼€ `report.html`ï¼Œä½ ä¼šçœ‹åˆ°ï¼š
- æµç¨‹æ‹“æ‰‘å›¾
- æ¯ä¸ªæ­¥éª¤çš„è¿è¡Œæ—¶é—´ã€èµ„æºæ¶ˆè€—
- è½¯ä»¶ç‰ˆæœ¬å¿«ç…§
- åµŒå…¥çš„ SVG å›¾ï¼ˆå¯ç›´æ¥ä¸‹è½½ï¼‰

---

## åœ¨ Slurm é›†ç¾¤ä¸Šé«˜æ•ˆè¿è¡Œ

å¤§å¤šæ•°é«˜æ ¡ HPC ä½¿ç”¨ **Slurm** ä½œä¸šè°ƒåº¦ç³»ç»Ÿã€‚Snakemake æä¾›ä¸¤ç§æ–¹å¼å¯¹æ¥ã€‚

### æ–¹å¼ä¸€ï¼šåŸç”Ÿ Slurm æ”¯æŒï¼ˆæ¨èï¼Œv7.0+ï¼‰

è¿™æ˜¯æœ€ç®€æ´çš„æ–¹å¼ï¼Œæ— éœ€å†™ sbatch æ¨¡æ¿ï¼š

```bash
snakemake \
  --slurm \
  --default-resources \
    slurm_account=my_lab \
    slurm_partition=cpu \
    mem_mb=8000 \
    runtime=120 \
  --jobs 100 \
  --use-conda
```

#### åœ¨è§„åˆ™ä¸­è¦†ç›–é»˜è®¤èµ„æº

```python
rule heavy_job:
    output: "big_result.txt"
    resources:
        mem_mb=64000,
        runtime=240,
        slurm_partition="highmem"
    shell: ...
```

#### MPI ä»»åŠ¡æ”¯æŒ

```python
rule mpi_analysis:
    output: "mpi.out"
    resources:
        tasks=32,
        mpi="srun"
    shell:
        "{resources.mpi} -n {resources.tasks} my_mpi_program > {output}"
```

> ğŸ’¡ æ³¨æ„ï¼š`srun` æ˜¯ Slurm çš„ MPI å¯åŠ¨å™¨ï¼Œå…¼å®¹ OpenMPIã€Intel MPI ç­‰

### æ–¹å¼äºŒï¼šé€šç”¨é›†ç¾¤æ¨¡å¼ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰

é€‚ç”¨äº PBSã€SGE ç­‰ç³»ç»Ÿï¼š

```bash
snakemake \
  --cluster "sbatch -p {resources.slurm_partition} -t {resources.runtime} --mem={resources.mem_mb}M" \
  --jobs 50 \
  --default-resources runtime=60 mem_mb=8000 slurm_partition=cpu
```

### ä½¿ç”¨ Profile ç®¡ç†é…ç½®

åˆ›å»º `~/.config/snakemake/slurm/config.yaml`ï¼š

```yaml
slurm: true
default-resources:
  - slurm_account=my_lab
  - slurm_partition=cpu
  - mem_mb=8000
  - runtime=120
jobs: 100
use-conda: true
rerun-incomplete: true
```

ç„¶ååªéœ€è¿è¡Œï¼š

```bash
snakemake --profile slurm
```

---

## å®è·µå»ºè®®

1. **ä½¿ç”¨ Conda ç¯å¢ƒ**ï¼šé¿å…ç³»ç»Ÿä¾èµ–æ±¡æŸ“
2. **æ ·æœ¬ä¿¡æ¯å¤–ç½®**ï¼šç”¨ `configfile: "config.yaml"` ç®¡ç†æ ·æœ¬è¡¨
3. **æ¨¡å—åŒ– Snakefile**ï¼šç”¨ `include:` æ‹†åˆ†å¤§å‹æµç¨‹
4. **æ ‡è®°ä¸´æ—¶æ–‡ä»¶**ï¼šèŠ‚çœç£ç›˜ç©ºé—´
5. **å®šæœŸç”ŸæˆæŠ¥å‘Š**ï¼šæ–¹ä¾¿åä½œä¸å½’æ¡£
6. **ç‰ˆæœ¬æ§åˆ¶æ•´ä¸ª workflow ç›®å½•**ï¼šåŒ…æ‹¬ Snakefileã€envsã€scripts


Snakemake ä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæ›´æ˜¯ä¸€ç§**ç§‘ç ”å·¥ç¨‹åŒ–æ€ç»´**çš„ä½“ç°ï¼š

- ä»â€œèƒ½è·‘å°±è¡Œâ€ â†’ â€œå¯é å¯é‡å¤â€
- ä»â€œæ‰‹åŠ¨è¿ç»´â€ â†’ â€œè‡ªåŠ¨åŒ–æµæ°´çº¿â€
- ä»â€œå•æœºè„šæœ¬â€ â†’ â€œé›†ç¾¤è§„æ¨¡åŒ–â€

æ— è®ºæ˜¯ PIã€åšå£«ç”Ÿè¿˜æ˜¯ç”Ÿä¿¡å·¥ç¨‹å¸ˆï¼ŒæŒæ¡ Snakemake éƒ½å°†æå¤§æå‡ä½ çš„ç§‘ç ”æ•ˆç‡ä¸æˆæœå¯ä¿¡åº¦ã€‚

> ğŸ“š å®˜æ–¹æ–‡æ¡£ï¼šhttps://snakemake.readthedocs.io  
> ğŸ GitHub ç¤ºä¾‹åº“ï¼šhttps://github.com/snakemake-workflows

