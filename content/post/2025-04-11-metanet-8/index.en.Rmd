---
title: MetaNetï¼šå¤šç»„å­¦ç½‘ç»œåˆ†æå·¥å…·ï½œ8.ç½‘ç»œç¨³å®šæ€§åˆ†æ
author: Peng Chen
date: '2025-04-16'
slug: metanet-8
categories:
  - R
tags:
  - network
  - R
description: ç½‘ç»œç¨³å®šæ€§æ˜¯ç†è§£åˆ†å­è°ƒæ§ï¼Œä»£è°¢ç½‘ç»œï¼Œç”Ÿæ€ç³»ç»Ÿç­‰ç¨³å¥æ€§çš„é‡è¦å› ç´ ã€‚
image: images/nc.png
math: ~
license: ~
hidden: no
comments: yes
---

```{r include=FALSE}
devtools::load_all("~/Documents/R/pcutils/")
devtools::load_all("~/Documents/R/MetaNet/MetaNet/")
data(otutab, package = "pcutils")
Packages <- c("dplyr", "pcutils", "kableExtra")
pcutils::lib_ps(Packages)
knitr::opts_chunk$set(message = FALSE,warning = FALSE,eval = FALSE,fig.width=8,fig.height=5)
```

é™¤äº†ä¹‹å‰è®²çš„ç½‘ç»œæ‹“æ‰‘ç‰¹å¾ï¼ˆæ•°å­¦æŒ‡æ ‡ï¼‰å¤–ï¼Œç½‘ç»œçš„ç¨³å®šæ€§ä¹Ÿæ˜¯ç”Ÿç‰©ç ”ç©¶çš„é‡ç‚¹ã€‚ç½‘ç»œç¨³å®šæ€§æ˜¯ç†è§£åˆ†å­è°ƒæ§ï¼Œä»£è°¢ç½‘ç»œï¼Œç”Ÿæ€ç³»ç»Ÿç­‰ç¨³å¥æ€§çš„é‡è¦å› ç´ ã€‚

æˆ‘ä»¬æ”¶é›†äº†è®¸å¤šæ–¹æ³•åœ¨MetaNetä¸­æ¥è®¡ç®—å’Œåæ˜ ç½‘ç»œçš„ç¨³å®šæ€§å’Œå¤æ‚æ€§ï¼Œè¿™äº›ç®—æ³•éƒ½æ˜¯**å¹¶è¡Œè®¡ç®—**çš„ï¼Œè¿™å¯ä»¥å¿«å¾—å¤šã€‚æ‰€æœ‰ç½‘ç»œç¨³å®šæ€§è®¡ç®—éƒ½æä¾›å¹¶è¡Œç‰ˆæœ¬ï¼Œä½¿ç”¨`parallel::detectCores()`è·å–è®¾å¤‡æ ¸æ•°ï¼Œå¹¶è®¾ç½®`threads >1`ä½¿ç”¨å¹¶è¡Œè®¡ç®—ã€‚


- è½¯ä»¶ä¸»é¡µï¼š<https://github.com/Asa12138/MetaNet> **å¤§å®¶å¯ä»¥å¸®å¿™åœ¨githubä¸Šç‚¹ç‚¹starâ­ï¸**ï¼Œè°¢è°¢ğŸ™
- è¯¦ç»†è‹±æ–‡ç‰ˆæ•™ç¨‹ï¼š<https://bookdown.org/Asa12138/metanet_book/>

å¯ä»¥ä» CRAN å®‰è£…ç¨³å®šç‰ˆï¼š`install.packages("MetaNet")`  

ä¾èµ–åŒ… `pcutils`å’Œ`igraph`ï¼ˆéœ€æå‰å®‰è£…ï¼‰ï¼Œæ¨èé…åˆ `dplyr` è¿›è¡Œæ•°æ®æ“ä½œã€‚

```r
library(MetaNet)
library(igraph)

# ========data manipulation
library(dplyr)
library(pcutils)
```

## å¤šç»„ç½‘ç»œæ„å»º

æ¯”è¾ƒåŸºäºä¸åŒç»„çš„ç½‘ç»œç¨³å®šæ€§éå¸¸é‡è¦ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç»„æ ·æœ¬ï¼šNSã€WSã€CSï¼Œn=6ï¼ˆ**åœ¨å®é™…ç ”ç©¶ä¸­ï¼Œnåº”è¯¥æ›´å¤§æ‰èƒ½å¾—åˆ°æœ‰æ„ä¹‰çš„ç»“æœ**ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ¯ç»„çš„ç½‘ç»œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚


```{r}
data("otutab", package = "pcutils")

table(metadata$Group)
# check all rows matched
all(colnames(otutab) == rownames(metadata))
```

- æˆ‘ä»¬å¯ä»¥ä»æ•´ä¸ªç½‘ç»œä¸­æå–ä¸‰ç»„å­ç½‘:

```{r eval=FALSE}
# extract three-group sub-nets
hebing(otutab, metadata$Group) -> otutab_G
head(otutab_G)

# whole network
t(otutab) -> totu
c_net_calculate(totu) -> corr
c_net_build(corr, r_threshold = 0.65) -> co_net

group_net_par <- extract_sample_net(co_net, otutab_G, save_net = "../Group_subnet")
group_nets <- readRDS("../Group_subnet.RDS")

names(group_nets)
```

- æˆ–è€…ä¸ºæ¯ä¸ªç»„ä¸“é—¨æ„å»ºä¸€ä¸ªç½‘ç»œï¼š

```{r eval=FALSE}
data("otutab", package = "pcutils")

totu <- t(otutab)
# check all rows matched
all(rownames(totu) == rownames(metadata))

# Use RMT threshold or not?
rmt <- FALSE
group_nets <- lapply(levels(metadata$Group), \(i){
  totu[rownames(filter(metadata, Group == !!i)), ] -> t_tmp
  t_tmp[, colSums(t_tmp) > 0] -> t_tmp
  c_net_calculate(t_tmp) -> c_tmp
  if (rmt) {
    RMT_threshold(c_tmp, verbose = F, out_dir = "test/") -> tmp_rmt
    r_thres <- tmp_rmt$r_threshold
  } else {
    r_thres <- 0.6
  }
  c_net_build(c_tmp, r_threshold = r_thres, p_threshold = 0.01, delete_single = T) -> n_tmp
  Abundance_df <- data.frame("Abundance" = colSums(t_tmp))
  c_net_set(n_tmp, Abundance_df, taxonomy %>% select("Phylum"), vertex_class = "Phylum", vertex_size = "Abundance")
})

names(group_nets) <- levels(metadata$Group)
```


## ç½‘ç»œç¨³å¥æµ‹è¯•

å‚è€ƒï¼šM. B. WU Jun, Natural Connectivity of Complex Networks. Chinese Physics Letters. 27, 78902â€“078902 (2010).

ç½‘ç»œçš„ç¨³å¥æµ‹è¯•ï¼ˆRobust testï¼‰æ˜¯è®¡ç®—è‡ªç„¶è”é€šåº¦æ¥è¿›è¡Œçš„ï¼Œå› ä¸ºå®ƒå¯ä»¥åæ˜ ç½‘ç»œçš„ç¨³å®šæ€§ã€‚å®ƒè®¤ä¸ºå¤æ‚ç½‘ç»œçš„åŠŸèƒ½å’Œæ€§èƒ½å–å†³äºå½“ä¸€ä¸ªç½‘ç»œçš„éƒ¨åˆ†èŠ‚ç‚¹è¢«ç ´åï¼ˆæˆ–ç§»é™¤ï¼‰æ—¶ï¼Œè¯¥ç½‘ç»œä¿æŒå…¶è¿é€šæ€§çš„èƒ½åŠ›ã€‚

æ¥çœ‹ä¸‹å›¾ï¼Œä¸¤ä¸ªé—­ç¯ç½‘ç»œã€‚ä¸¤ä¸ªç½‘ç»œéƒ½å«æœ‰a-eå…±5ä¸ªèŠ‚ç‚¹ï¼Œç†è®ºä¸Šï¼Œä¸¤ä¸ªç½‘ç»œä¸­ä»»æ„èŠ‚ç‚¹é—´éƒ½æ˜¯ç›¸é€šçš„ï¼Œä¹Ÿå°±æ˜¯ä»ä¸€ä¸ªèŠ‚ç‚¹å‡ºå‘ï¼Œæ— è®ºé€‰æ‹©æ€æ ·çš„è·¯å¾„ï¼Œæœ€ç»ˆéƒ½èƒ½åˆ°è¾¾å¦ä¸€èŠ‚ç‚¹ã€‚
ä½†æ˜¯å½“æˆ‘ä»¬è¿›è¡ŒèŠ‚ç‚¹æˆ–è¾¹çš„ç§»é™¤ï¼Œæ¯”å¦‚åˆ é™¤edï¼Œå·¦è¾¹è¿˜èƒ½ed2æ¡è¾¹ç›¸è¿ï¼Œå³è¾¹å°±è¦5æ¡è¾¹æ‰èƒ½è¿ä¸Šï¼Œç§»é™¤æ›´å¤šçš„è¾¹æ—¶å³è¾¹çš„ç½‘ç»œå°±ä¼šå‡ºç°å­¤ç«‹èŠ‚ç‚¹ã€‚

è‡ªç„¶è¿é€šåº¦ä»å¤æ‚ç½‘ç»œçš„å†…éƒ¨ç»“æ„å±æ€§å‡ºå‘ï¼Œé€šè¿‡è®¡ç®—ç½‘ç»œä¸­ä¸åŒé•¿åº¦é—­é€”å¾„æ•°ç›®çš„åŠ æƒå’Œæ¥åˆ»ç”»ç½‘ç»œä¸­æ›¿ä»£é€”å¾„çš„å†—ä½™æ€§ï¼Œå…¶æ•°å­¦å½¢å¼å¯ä»¥ä»ç½‘ç»œé‚»æ¥çŸ©é˜µç‰¹å¾è°±ç›´æ¥å¯¼å‡ºï¼Œå…·æœ‰æ˜ç¡®çš„ç‰©ç†æ„ä¹‰ï¼Œä½†æ¯”è¾ƒå¤æ‚ã€‚
è‡ªç„¶è¿é€šåº¦å…³äºç§»é™¤èŠ‚ç‚¹æˆ–è¾¹æ˜¯å•è°ƒå‡çš„ï¼Œè¿™æ„å‘³ç€è‡ªç„¶è¿é€šåº¦èƒ½å¤Ÿç²¾ç¡®åˆ»ç”»ç½‘ç»œæŠ—æ¯æ€§çš„ç»†å¾®å·®åˆ«ï¼Œä¸”å¯¹äºä¸è¿é€šå›¾ä»ç„¶æœ‰æ•ˆã€‚

å³ä¸‹è§’è¿™ä¸ªä¾‹å­å°±æ˜¯é€æ­¥ç§»å‡ºç½‘ç»œçš„èŠ‚ç‚¹ï¼Œè§‚å¯Ÿè‡ªç„¶è”é€šåº¦çš„ä¸‹é™è¶‹åŠ¿ï¼Œè¶Šå¹³ç¼“çš„è¯´æ˜ç¨³å®šæ€§è¶Šå¥½

![](images/nc.png)

å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ é™¤èŠ‚ç‚¹åè®¡ç®—è‡ªç„¶è¿æ¥ï¼ˆä¸€æ¬¡ä»ç½‘ç»œä¸­åˆ é™¤å¤šä¸ªèŠ‚ç‚¹ï¼Œç›´åˆ°æŒ‡å®šæ¯”ä¾‹çš„èŠ‚ç‚¹æ¶ˆå¤±ï¼‰ï¼Œ
è‡ªç„¶è¿é€šæ€§çš„ä¸‹é™è¶‹åŠ¿æ°´å¹³è¡¨æ˜äº†ç½‘ç»œåœ¨å—åˆ°ä¸€å®šç¨‹åº¦çš„ç ´ååçš„è¿é€šæ€§æ€§èƒ½ã€‚

```{r eval=FALSE}
#å»ºè®®â€œrepsâ€å¤§äº99ï¼Œæ‚¨å¯ä»¥å°†â€œthreads>1â€è®¾ç½®ä¸ºä½¿ç”¨å¹¶è¡Œè®¡ç®—ã€‚
robust_test(group_nets, partial = 0.5, step = 10, reps = 9, threads = 1) -> robust_res
plot(robust_res, mode = 2)
```

![](https://bookdown.org/Asa12138/metanet_book/images/6-1.robust_res.png)


## ç½‘ç»œç¾¤è½ç¨³å®šæ€§

ç¾¤è½ç¨³å®šæ€§å¯ä»¥ç”¨å„ç§æŒ‡æ ‡æ¥è¡¨å¾ï¼Œå¦‚é²æ£’æ€§ï¼ˆRobustnessï¼‰ã€è„†å¼±æ€§(Vulnerability)å’Œå‡èšåŠ›ã€‚

### Robustness

å‚è€ƒ Yuan, M. M. et al. Climate warming enhances microbial network complexity and stability. Nat. Clim. Chang. 11, 343â€“348 (2021).

ä½œè€…å°†ç½‘ç»œçš„é²æ£’æ€§ï¼ˆRobustnessï¼‰å®šä¹‰ä¸ºç½‘ç»œåœ¨éšæœºæˆ–æœ‰é’ˆå¯¹æ€§çš„èŠ‚ç‚¹åˆ é™¤åå¯¹èŠ‚ç‚¹ä¸¢å¤±çš„æŠµæŠ—åŠ›ã€‚

ä¸ºäº†æ¨¡æ‹Ÿéšæœºç‰©ç§å»é™¤ï¼Œéšæœºå»é™¤ä¸€å®šæ¯”ä¾‹çš„èŠ‚ç‚¹ï¼Œä¸ºäº†æµ‹è¯•ç§»é™¤çš„ç‰©ç§å¯¹å‰©ä½™ç‰©ç§çš„å½±å“ï¼Œä½œè€…è®¡ç®—äº†èŠ‚ç‚¹ i çš„ä¸°åº¦åŠ æƒå¹³å‡ç›¸äº’ä½œç”¨å¼ºåº¦ï¼ˆwMISï¼‰ï¼šç§»é™¤æ‰€é€‰èŠ‚ç‚¹åï¼Œå¦‚æœ wMISi = 0ï¼ˆä¸ç‰©ç§ i ç›¸å…³çš„æ‰€æœ‰ç‰©ç§éƒ½è¢«ç§»é™¤ï¼‰ ï¼‰æˆ– wMISi < 0ï¼ˆç‰©ç§ i ä¸å…¶ä»–ç‰©ç§æ²¡æœ‰è¶³å¤Ÿçš„äº’æƒ å…³è”ä»¥ä½¿å…¶ç”Ÿå­˜ï¼‰ï¼Œåˆ™èŠ‚ç‚¹ i è¢«è§†ä¸ºç­ç»/å­¤ç«‹å¹¶ä»ç½‘ç»œä¸­åˆ é™¤ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸€ç›´æŒç»­åˆ°æ‰€æœ‰ç‰©ç§çš„ wMIS å‘ˆæ­£æ•°ä¸ºæ­¢ã€‚ å‰©ä½™èŠ‚ç‚¹çš„æ¯”ä¾‹è¢«æŠ¥å‘Šä¸ºç½‘ç»œé²æ£’æ€§ã€‚

```{r eval=FALSE}
#å»ºè®®â€œrepsâ€å¤§äº99ï¼Œæ‚¨å¯ä»¥å°†â€œthreads>1â€è®¾ç½®ä¸ºä½¿ç”¨å¹¶è¡Œè®¡ç®—ã€‚
robustness(group_nets, keystone = F, reps = 99, threads = 1) -> robustness_res
plot(robustness_res, p_value2 = T)
```

![](https://bookdown.org/Asa12138/metanet_book/images/6-2.robustness.png){width=60%}

### Vulnerability

å‚è€ƒ Yuan, M. M. et al. Climate warming enhances microbial network complexity and stability. Nat. Clim. Chang. 11, 343â€“348 (2021).

ä¸ºäº†è¯„ä¼°ç½‘ç»œå†…å¹²æ‰°ä¼ æ’­çš„é€Ÿåº¦ï¼Œå…¨å±€æ•ˆç‡è¢«è§†ä¸ºæ‰€æœ‰èŠ‚ç‚¹å¯¹æ•ˆç‡çš„å¹³å‡å€¼ï¼Œå…¶é€šè¿‡æˆå¯¹èŠ‚ç‚¹ä¹‹é—´çš„æœ€çŸ­è·¯å¾„ä¸­çš„è¾¹çš„æ•°é‡æ¥è®¡ç®—ã€‚

è„†å¼±æ€§(Vulnerability)åæ˜ äº†æ¯ä¸ªèŠ‚ç‚¹å¯¹å…¨å±€æ•ˆç‡çš„ç›¸å¯¹è´¡çŒ®ï¼Œç”±ç½‘ç»œä¸­èŠ‚ç‚¹çš„æœ€å¤§è„†å¼±æ€§è¡¨ç¤ºã€‚

$$
Vulnerability=\max\left(\frac{E-E_i}E\right)
$$

å…¶ä¸­Eæ˜¯å…¨å±€æ•ˆç‡ï¼ŒEiæ˜¯å»é™¤èŠ‚ç‚¹iåŠå…¶æ•´ä¸ªé“¾è·¯åçš„å…¨å±€æ•ˆç‡ã€‚å›¾çš„å…¨å±€æ•ˆç‡è®¡ç®—ä¸ºæ‰€æœ‰èŠ‚ç‚¹å¯¹æ•ˆç‡çš„å¹³å‡å€¼ï¼š

$$
E=\frac1{n(n-1)}\sum_{i\neq j}\frac1{d(i,j)}
$$
å…¶ä¸­dï¼ˆiï¼Œjï¼‰æ˜¯èŠ‚ç‚¹iå’Œjä¹‹é—´çš„æœ€çŸ­è·¯å¾„é•¿åº¦ã€‚

```{r eval=FALSE}
vulnerability_res <- vulnerability(group_nets, threads = 1)
plot(vulnerability_res)
```

![](https://bookdown.org/Asa12138/metanet_book/images/6-3.vulnerability.png){width=60%}

### Cohesion

å‚è€ƒ C. M. Herren, K. McMahon, Cohesion: A method for quantifying the connectivity of microbial communities (2017), doi:10.1038/ismej.2017.91.

è¿˜æœ‰ä¸€ä¸ªæŒ‡æ ‡æ˜¯cohesionå‡èšåŠ›æŒ‡æ•°ï¼Œé€šè¿‡åˆ†åˆ«è¡¨å¾ç¾¤è½ä¸­ç‰©ç§é—´çš„æ­£è´Ÿå…±ç°å…³ç³»ï¼Œæ¥äº†è§£ç”±æ­£/è´Ÿç‰©ç§ç›¸äº’ä½œç”¨æˆ–ç”±ç”Ÿæ€ä½ç›¸ä¼¼æ€§/å·®å¼‚å¼•èµ·ç¾¤è½è¿é€šæ€§è·¨æ—¶é—´ã€ç©ºé—´æˆ–ç¯å¢ƒæ¢¯åº¦çš„å˜åŒ–ã€‚

![](images/cohesion.png)

é¦–å…ˆä»ä¸°åº¦è¡¨æ„å»ºç›¸å…³æ€§çŸ©é˜µï¼Œç„¶åå¯¹å®ƒåšé›¶æ¨¡å‹æ¶ˆé™¤éšæœºæ•ˆåº”ï¼Œè¿™æ ·å¯¹äºæ¯ä¸€ä¸ªç‰©ç§ï¼Œéƒ½æœ‰ä¸å…¶ä»–æ‰€æœ‰ç‰©ç§çš„ç›¸å…³æ€§ï¼Œç„¶åæŠŠå…¶ä¸­çš„æ­£å€¼è´Ÿå€¼åˆ†å¼€å–å¹³å‡ï¼Œå°±èƒ½å¾—åˆ°æ¯ä¸ªç‰©ç§çš„connectednessï¼Œå†ä¹˜ä¸Šä¸°åº¦è¡¨ï¼Œå°±èƒ½å¾—åˆ°æ¯ä¸€ä¸ªæ ·æœ¬çš„æ­£è´Ÿå‡èšåŠ›äº†ã€‚

$$
\text{Cohesion}=\sum_{i=1}^n\text{abundance}_i\times\text{connectednes}s_i
$$

![](images/cohesion2.png)

æ­£Cohesionæ˜¯ç”±ä¸¤ä¸¤æ­£ç›¸å…³äº§ç”Ÿçš„ï¼Œå¯ä»¥åæ˜ æ ·æœ¬ä¸­åˆä½œè¡Œä¸ºçš„ç¨‹åº¦ï¼Œè€Œè´ŸCohesionå¯ä»¥è¡¨æ˜ç¾¤è½æˆå‘˜ä¹‹é—´ç«äº‰è¡Œä¸ºçš„ç¨‹åº¦ã€‚ç„¶åä½œè€…è®¤ä¸ºè´Ÿï¼šæ­£Cohesionçš„ç»å¯¹å€¼è¶Šé«˜çš„çš„ç¾¤è½æ›´ç¨³å®šã€‚ï¼ˆHernandez, D. J., David, A. S., Menges, E. S., Searcy, C. A. & Afkhami, M. E. Environmental stress destabilizes microbial networks. ISME J 15, 1722â€“1734 (2021).ï¼‰


```{r eval=FALSE}
#å»ºè®®â€œrepsâ€å¤§äº99ï¼Œæ‚¨å¯ä»¥å°†â€œthreads>1â€è®¾ç½®ä¸ºä½¿ç”¨å¹¶è¡Œè®¡ç®—ã€‚
Cohesion(otutab, reps = 9, threads = 1) -> cohesion_res
p1 <- plot(cohesion_res, group = "Group", metadata, mode = 1) + theme_bw()
p2 <- plot(cohesion_res, group = "Group", metadata, mode = 2)
p1 + p2
```

![](https://bookdown.org/Asa12138/metanet_book/images/6-4.Cohesion.png)

## References
1. Yuan, M. M. et al. Climate warming enhances microbial network complexity and stability. Nat. Clim. Chang. 11, 343â€“348 (2021).
2. M. B. WU Jun, Natural Connectivity of Complex Networks. Chinese Physics Letters. 27, 78902â€“078902 (2010).
3. C. M. Herren, K. McMahon, Cohesion: A method for quantifying the connectivity of microbial communities (2017), doi:10.1038/ismej.2017.91.
4. Hernandez, D. J., David, A. S., Menges, E. S., Searcy, C. A. & Afkhami, M. E. Environmental stress destabilizes microbial networks. ISME J 15, 1722â€“1734 (2021).